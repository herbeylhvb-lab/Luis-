<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Block Captain Portal</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#0f172a;color:#e2e8f0;min-height:100vh}

/* Login screen */
.login-screen{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:2rem}
.login-card{background:#1e293b;border:1px solid #334155;border-radius:16px;padding:2rem;max-width:400px;width:100%;text-align:center}
.login-card h2{font-size:1.5rem;margin-bottom:0.5rem;color:#f59e0b}
.login-card p{color:#94a3b8;font-size:0.9rem;margin-bottom:1.5rem}
.form-group{margin-bottom:1rem;text-align:left}
.form-group label{display:block;font-size:13px;color:#94a3b8;margin-bottom:6px}
.form-group input,.form-group select{width:100%;background:#0f172a;border:1px solid #334155;border-radius:8px;padding:12px 14px;color:#e2e8f0;font-size:16px;outline:none}
.form-group input:focus,.form-group select:focus{border-color:#f59e0b}
.code-input{text-align:center;font-size:24px!important;letter-spacing:6px;font-weight:700;text-transform:uppercase}
.error-msg{color:#ef4444;font-size:14px;margin-top:0.5rem}
.btn{display:inline-flex;align-items:center;gap:6px;padding:12px 24px;border:none;border-radius:8px;font-size:15px;font-weight:600;cursor:pointer}
.btn:hover{opacity:0.85}
.btn:disabled{opacity:0.5;cursor:not-allowed}
.btn-captain{background:#f59e0b;color:#000;width:100%;justify-content:center}
.btn-primary{background:#818cf8;color:#fff}
.btn-success{background:#22c55e;color:#fff}
.btn-danger{background:#ef4444;color:#fff}
.btn-secondary{background:#334155;color:#e2e8f0}
.btn-sm{padding:6px 14px;font-size:13px}
.btn-xs{padding:4px 10px;font-size:12px;border-radius:6px}
.back-link{display:inline-flex;align-items:center;gap:4px;color:#94a3b8;font-size:13px;margin-top:1rem;cursor:pointer;text-decoration:none}
.back-link:hover{color:#e2e8f0}

/* Main layout */
.app-header{background:#1e293b;border-bottom:1px solid #334155;padding:12px 20px;display:flex;align-items:center;justify-content:space-between}
.app-header h1{font-size:18px;font-weight:700}
.app-header h1 span{color:#f59e0b}
.app-header .info{font-size:13px;color:#94a3b8}
.btn-leave{padding:6px 14px;background:#ef4444;color:#fff;border:none;border-radius:6px;font-size:13px;cursor:pointer}

.app-layout{display:flex;height:calc(100vh - 52px);overflow:hidden}

/* Left sidebar */
.sidebar{width:260px;background:#1e293b;border-right:1px solid #334155;overflow-y:auto;flex-shrink:0;display:flex;flex-direction:column}
.sidebar-section{padding:14px 16px 6px;font-size:11px;font-weight:600;color:#64748b;text-transform:uppercase;letter-spacing:1px}
.list-item{display:flex;align-items:center;justify-content:space-between;padding:10px 16px;cursor:pointer;font-size:14px;color:#94a3b8;transition:background 0.15s;border-left:3px solid transparent}
.list-item:hover{background:#334155}
.list-item.active{background:#334155;color:#f59e0b;border-left-color:#f59e0b}
.list-item .count{font-size:12px;color:#64748b;background:#0f172a;padding:2px 8px;border-radius:9999px}
.team-tag{font-size:11px;color:#818cf8;margin-left:4px}
.sidebar-actions{padding:12px 16px;border-top:1px solid #334155;margin-top:auto}
.sidebar-btn{display:block;width:100%;padding:8px;border:1px dashed #475569;border-radius:8px;background:transparent;color:#94a3b8;font-size:13px;cursor:pointer;text-align:center;margin-bottom:8px}
.sidebar-btn:hover{border-color:#f59e0b;color:#f59e0b}

/* Center panel */
.center-panel{flex:1;overflow-y:auto;padding:20px}
.search-bar{position:relative;margin-bottom:20px}
.search-bar input{width:100%;background:#1e293b;border:1px solid #334155;border-radius:10px;padding:14px 18px;color:#e2e8f0;font-size:15px;outline:none}
.search-bar input:focus{border-color:#f59e0b}
.search-bar .hint{position:absolute;right:14px;top:50%;transform:translateY(-50%);font-size:12px;color:#64748b}

.voter-card{background:#1e293b;border:1px solid #334155;border-radius:12px;padding:16px;margin-bottom:12px;animation:fadeIn 0.2s ease}
.voter-card .voter-top{display:flex;justify-content:space-between;align-items:flex-start}
.voter-card .voter-name{font-weight:700;font-size:16px}
.voter-card .voter-addr{color:#94a3b8;font-size:13px;margin-top:4px}
.voter-card .voter-meta{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.voter-card .voter-history{color:#64748b;font-size:12px;margin-top:6px}
.badge{display:inline-block;padding:2px 8px;border-radius:9999px;font-size:11px;font-weight:600}
.badge-green{background:#052e16;color:#4ade80}
.badge-red{background:#450a0a;color:#fca5a5}
.badge-blue{background:#0c1a3d;color:#93c5fd}
.badge-yellow{background:#422006;color:#fcd34d}
.badge-purple{background:#2e1065;color:#c4b5fd}
.badge-gray{background:#1e293b;color:#94a3b8;border:1px solid #334155}
.badge-amber{background:#451a03;color:#fcd34d;border:1px solid #78350f}

.household-section{margin-top:12px;padding-top:12px;border-top:1px solid #334155}
.household-section h4{font-size:13px;color:#64748b;margin-bottom:8px}
.household-member{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:#0f172a;border:1px solid #334155;border-radius:8px;margin-bottom:6px;font-size:13px}

.empty-state{text-align:center;padding:3rem 1rem;color:#64748b}
.empty-state .icon{font-size:3rem;margin-bottom:0.5rem}

/* Right panel */
.right-panel{width:350px;background:#1e293b;border-left:1px solid #334155;overflow-y:auto;flex-shrink:0;display:flex;flex-direction:column}
.right-header{padding:16px;border-bottom:1px solid #334155}
.right-header h3{font-size:15px;margin-bottom:2px}
.right-header .sub{font-size:12px;color:#64748b}
.right-list{flex:1;overflow-y:auto;padding:8px}
.right-voter{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #334155;font-size:13px}
.right-voter:last-child{border-bottom:none}
.right-voter .name{font-weight:600;color:#e2e8f0}
.right-voter .addr{color:#64748b;font-size:12px;margin-top:2px}
.remove-btn{background:none;border:none;color:#ef4444;cursor:pointer;font-size:16px;padding:4px 8px;border-radius:4px}
.remove-btn:hover{background:#450a0a}

.right-empty{text-align:center;padding:3rem 1rem;color:#475569;font-size:14px}

/* Modal */
.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:100}
.modal-box{background:#1e293b;border:1px solid #334155;border-radius:16px;padding:28px;max-width:400px;width:90%}
.modal-box h3{margin-bottom:16px;font-size:16px}

/* Responsive */
@media(max-width:900px){
  .app-layout{flex-direction:column;height:auto}
  .sidebar{width:100%;max-height:40vh;border-right:none;border-bottom:1px solid #334155}
  .right-panel{width:100%;max-height:40vh;border-left:none;border-top:1px solid #334155}
}

@keyframes fadeIn{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}

/* CSV Import Modal */
.csv-modal-box{background:#1e293b;border:1px solid #334155;border-radius:16px;padding:28px;max-width:700px;width:95%;max-height:85vh;overflow-y:auto}
.csv-step{display:none}
.csv-step.active{display:block}
.csv-col-row{display:flex;align-items:center;gap:8px;padding:4px 0}
.csv-col-label{color:#94a3b8;font-size:13px;min-width:130px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.csv-col-arrow{color:#64748b;font-size:12px}
.csv-col-select{background:#0f172a;border:1px solid #334155;border-radius:6px;padding:5px 8px;color:#e2e8f0;font-size:13px;flex:1}
.csv-preview-table{width:100%;border-collapse:collapse;font-size:12px;margin:8px 0}
.csv-preview-table th,.csv-preview-table td{padding:4px 8px;border:1px solid #334155;text-align:left;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.csv-preview-table th{background:#0f172a;color:#94a3b8}
.csv-result-section{margin-bottom:16px;padding:12px;border-radius:8px}
.csv-result-auto{background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.3)}
.csv-result-review{background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.3)}
.csv-result-none{background:rgba(100,116,139,0.1);border:1px solid rgba(100,116,139,0.3)}
.csv-review-item{background:#0f172a;border:1px solid #334155;border-radius:8px;padding:12px;margin-bottom:8px}
.csv-review-csv-row{color:#94a3b8;font-size:12px;margin-bottom:8px;padding-bottom:8px;border-bottom:1px solid #334155}
.csv-review-candidate{display:flex;align-items:center;gap:8px;padding:6px 8px;border-radius:6px;cursor:pointer;font-size:13px}
.csv-review-candidate:hover{background:#1e293b}
</style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div class="login-screen" id="loginScreen">
  <div class="login-card">
    <div style="font-size:2.5rem;margin-bottom:0.5rem">&#128081;</div>
    <h2>Block Captain Portal</h2>
    <p>Enter your captain code to access your voter lists and team.</p>
    <div class="form-group">
      <label>Captain Code</label>
      <input type="text" id="captainCode" class="code-input" placeholder="A3F82C" maxlength="6">
    </div>
    <button class="btn btn-captain" id="btnLogin" onclick="loginCaptain()">Enter Portal</button>
    <div class="error-msg" id="loginError"></div>
    <a class="back-link" href="/volunteer">&#8592; Back to Volunteer Hub</a>
  </div>
</div>

<!-- MAIN APP -->
<div id="appScreen" style="display:none">
  <div class="app-header">
    <div>
      <h1>&#128081; <span>Block Captain</span></h1>
      <div class="info" id="captainGreeting"></div>
    </div>
    <button class="btn-leave" onclick="logoutCaptain()">Log Out</button>
  </div>

  <div class="app-layout">
    <!-- LEFT SIDEBAR: Lists & Team -->
    <div class="sidebar">
      <div class="sidebar-section">My Lists</div>
      <div id="myListsContainer"></div>

      <div class="sidebar-section">Team Lists</div>
      <div id="teamListsContainer"></div>

      <div class="sidebar-actions">
        <button class="sidebar-btn" onclick="showNewListModal()">+ New List</button>
        <button class="sidebar-btn" onclick="addTeamMember()">+ Add Team Member</button>
      </div>
    </div>

    <!-- CENTER: Search -->
    <div class="center-panel">
      <div class="search-bar">
        <input type="text" id="voterSearch" placeholder="Search voters by name, address, or phone..." oninput="debouncedSearch()">
        <span class="hint">min 2 chars</span>
      </div>
      <div id="searchResults">
        <div class="empty-state">
          <div class="icon">&#128270;</div>
          <p>Search for voters to add them to your lists.</p>
        </div>
      </div>
    </div>

    <!-- RIGHT: Current List View -->
    <div class="right-panel">
      <div class="right-header">
        <h3 id="rightListName">Select a List</h3>
        <div class="sub" id="rightListSub">Choose a list from the sidebar to view voters</div>
      </div>
      <div class="right-list" id="rightListContent">
        <div class="right-empty">Select a list from the sidebar</div>
      </div>
    </div>
  </div>
</div>

<script>
var captainState = {
  captain: null,
  selectedListId: null,
  selectedListName: '',
  searchTimeout: null
};

function esc(t) {
  var d = document.createElement('div');
  d.textContent = t;
  return d.innerHTML;
}

async function api(path, opts) {
  var res = await fetch(path, opts);
  return res.json();
}

// ===================== LOGIN =====================

async function loginCaptain() {
  var code = document.getElementById('captainCode').value.trim();
  var errEl = document.getElementById('loginError');
  errEl.textContent = '';
  if (!code) { errEl.textContent = 'Please enter your captain code.'; return; }

  document.getElementById('btnLogin').disabled = true;
  try {
    var data = await api('/api/captains/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ code: code })
    });
    if (data.error) {
      errEl.textContent = data.error;
      document.getElementById('btnLogin').disabled = false;
      return;
    }
    captainState.captain = data.captain;
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('appScreen').style.display = '';
    document.getElementById('captainGreeting').textContent = 'Welcome, ' + data.captain.name;
    refreshSidebar();
  } catch (e) {
    errEl.textContent = 'Network error. Please try again.';
    document.getElementById('btnLogin').disabled = false;
  }
}

function logoutCaptain() {
  captainState.captain = null;
  captainState.selectedListId = null;
  document.getElementById('appScreen').style.display = 'none';
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('captainCode').value = '';
  document.getElementById('btnLogin').disabled = false;
}

// ===================== SIDEBAR =====================

async function refreshSidebar() {
  var data = await api('/api/captains/' + captainState.captain.id + '/lists');
  var lists = data.lists || [];
  captainState.captain.lists = lists;

  // Separate my lists vs team lists
  var myLists = lists.filter(function(l) { return !l.team_member_name; });
  var teamLists = lists.filter(function(l) { return l.team_member_name; });

  var myEl = document.getElementById('myListsContainer');
  myEl.textContent = '';
  if (myLists.length === 0) {
    var empty = document.createElement('div');
    empty.style.cssText = 'padding:12px 16px;color:#475569;font-size:13px';
    empty.textContent = 'No lists yet. Create one below!';
    myEl.appendChild(empty);
  }
  myLists.forEach(function(l) { myEl.appendChild(makeListItem(l)); });

  var teamEl = document.getElementById('teamListsContainer');
  teamEl.textContent = '';
  if (teamLists.length === 0) {
    var empty2 = document.createElement('div');
    empty2.style.cssText = 'padding:12px 16px;color:#475569;font-size:13px';
    empty2.textContent = 'No team lists yet.';
    teamEl.appendChild(empty2);
  }
  teamLists.forEach(function(l) { teamEl.appendChild(makeListItem(l)); });
}

function makeListItem(l) {
  var item = document.createElement('div');
  item.className = 'list-item' + (captainState.selectedListId === l.id ? ' active' : '');
  var left = document.createElement('div');
  left.textContent = l.name;
  if (l.team_member_name) {
    var tag = document.createElement('span');
    tag.className = 'team-tag';
    tag.textContent = '(' + l.team_member_name + ')';
    left.appendChild(tag);
  }
  item.appendChild(left);
  var count = document.createElement('span');
  count.className = 'count';
  count.textContent = l.voter_count || 0;
  item.appendChild(count);
  item.addEventListener('click', function() { selectList(l.id, l.name); });
  return item;
}

// ===================== LIST SELECTION =====================

async function selectList(listId, listName) {
  captainState.selectedListId = listId;
  captainState.selectedListName = listName;
  refreshSidebar();
  await loadListVoters();
}

async function loadListVoters() {
  if (!captainState.selectedListId) return;
  var data = await api('/api/captains/' + captainState.captain.id + '/lists/' + captainState.selectedListId + '/voters');
  var voters = data.voters || [];

  var nameEl = document.getElementById('rightListName');
  nameEl.textContent = captainState.selectedListName;
  document.getElementById('rightListSub').textContent = voters.length + ' voter' + (voters.length !== 1 ? 's' : '');

  // Add Upload CSV button to right header
  var oldCsvBtn = document.getElementById('btnUploadCsv');
  if (oldCsvBtn) oldCsvBtn.remove();
  var headerRow = nameEl.parentNode;
  headerRow.style.cssText = 'padding:16px;border-bottom:1px solid #334155;display:flex;align-items:center;flex-wrap:wrap;gap:8px';
  var csvBtn = document.createElement('button');
  csvBtn.id = 'btnUploadCsv';
  csvBtn.className = 'btn btn-xs btn-captain';
  csvBtn.style.marginLeft = 'auto';
  csvBtn.textContent = '\uD83D\uDCC4 Upload CSV';
  csvBtn.addEventListener('click', function() { openCsvImportModal(); });
  headerRow.appendChild(csvBtn);

  var el = document.getElementById('rightListContent');
  el.textContent = '';

  if (voters.length === 0) {
    var emptyDiv = document.createElement('div');
    emptyDiv.className = 'right-empty';
    emptyDiv.textContent = 'No voters in this list yet. Search and add voters from the center panel.';
    el.appendChild(emptyDiv);
    return;
  }

  voters.forEach(function(v) {
    var row = document.createElement('div');
    row.className = 'right-voter';

    var info = document.createElement('div');
    var n = document.createElement('div');
    n.className = 'name';
    n.textContent = (v.first_name || '') + ' ' + (v.last_name || '');
    info.appendChild(n);
    var a = document.createElement('div');
    a.className = 'addr';
    a.textContent = (v.address || '') + (v.city ? ', ' + v.city : '') + (v.zip ? ' ' + v.zip : '');
    info.appendChild(a);

    row.appendChild(info);

    var btn = document.createElement('button');
    btn.className = 'remove-btn';
    btn.textContent = '\u00D7';
    btn.title = 'Remove from list';
    btn.addEventListener('click', function() { removeVoterFromList(v.id); });
    row.appendChild(btn);

    el.appendChild(row);
  });
}

// ===================== SEARCH =====================

function debouncedSearch() {
  clearTimeout(captainState.searchTimeout);
  captainState.searchTimeout = setTimeout(searchVoters, 300);
}

async function searchVoters() {
  var q = document.getElementById('voterSearch').value.trim();
  var el = document.getElementById('searchResults');
  if (q.length < 2) {
    el.textContent = '';
    var emptyDiv = document.createElement('div');
    emptyDiv.className = 'empty-state';
    var icon = document.createElement('div');
    icon.className = 'icon';
    icon.textContent = '\uD83D\uDD0D';
    emptyDiv.appendChild(icon);
    var p = document.createElement('p');
    p.textContent = 'Search for voters to add them to your lists.';
    emptyDiv.appendChild(p);
    el.appendChild(emptyDiv);
    return;
  }

  var data = await api('/api/captains/' + captainState.captain.id + '/search?q=' + encodeURIComponent(q));
  var voters = data.voters || [];

  el.textContent = '';
  if (voters.length === 0) {
    var noResult = document.createElement('div');
    noResult.className = 'empty-state';
    var noIcon = document.createElement('div');
    noIcon.className = 'icon';
    noIcon.textContent = '\uD83D\uDE36';
    noResult.appendChild(noIcon);
    var noP = document.createElement('p');
    noP.textContent = 'No voters found for "' + q + '"';
    noResult.appendChild(noP);
    el.appendChild(noResult);
    return;
  }

  voters.forEach(function(v) {
    var card = document.createElement('div');
    card.className = 'voter-card';

    // Top row: name + add button
    var top = document.createElement('div');
    top.className = 'voter-top';

    var nameDiv = document.createElement('div');
    var nameEl = document.createElement('div');
    nameEl.className = 'voter-name';
    nameEl.textContent = (v.first_name || '') + ' ' + (v.last_name || '');
    nameDiv.appendChild(nameEl);

    var addrEl = document.createElement('div');
    addrEl.className = 'voter-addr';
    addrEl.textContent = (v.address || '') + (v.city ? ', ' + v.city : '') + (v.zip ? ' ' + v.zip : '');
    nameDiv.appendChild(addrEl);
    top.appendChild(nameDiv);

    if (captainState.selectedListId) {
      var addBtn = document.createElement('button');
      addBtn.className = 'btn btn-sm btn-captain';
      addBtn.textContent = '+ Add';
      addBtn.addEventListener('click', function() { addVoterToList(v.id); });
      top.appendChild(addBtn);
    } else {
      var hint = document.createElement('span');
      hint.style.cssText = 'font-size:11px;color:#64748b';
      hint.textContent = 'Select a list first';
      top.appendChild(hint);
    }
    card.appendChild(top);

    // Meta badges
    var meta = document.createElement('div');
    meta.className = 'voter-meta';
    if (v.party) {
      var partyBadge = document.createElement('span');
      var partyColors = { D: 'badge-blue', R: 'badge-red', Democrat: 'badge-blue', Republican: 'badge-red', DEM: 'badge-blue', REP: 'badge-red' };
      partyBadge.className = 'badge ' + (partyColors[v.party] || 'badge-gray');
      partyBadge.textContent = v.party;
      meta.appendChild(partyBadge);
    }
    if (v.support_level && v.support_level !== 'unknown') {
      var supportBadge = document.createElement('span');
      var supportColors = { strong_support:'badge-green', lean_support:'badge-green', undecided:'badge-yellow', lean_oppose:'badge-red', strong_oppose:'badge-red' };
      supportBadge.className = 'badge ' + (supportColors[v.support_level] || 'badge-gray');
      supportBadge.textContent = (v.support_level || '').replace(/_/g, ' ');
      meta.appendChild(supportBadge);
    }
    if (v.voter_score) {
      var scoreBadge = document.createElement('span');
      scoreBadge.className = 'badge badge-purple';
      scoreBadge.textContent = 'Score: ' + v.voter_score;
      meta.appendChild(scoreBadge);
    }
    if (v.phone) {
      var phoneBadge = document.createElement('span');
      phoneBadge.className = 'badge badge-gray';
      phoneBadge.textContent = v.phone;
      meta.appendChild(phoneBadge);
    }
    card.appendChild(meta);

    // Voting history
    if (v.voting_history) {
      var hist = document.createElement('div');
      hist.className = 'voter-history';
      hist.textContent = 'Voted: ' + v.voting_history;
      card.appendChild(hist);
    }

    // Household section
    var hhContainer = document.createElement('div');
    hhContainer.id = 'hh-' + v.id;
    card.appendChild(hhContainer);
    loadHousehold(v.id, hhContainer);

    el.appendChild(card);
  });
}

// ===================== HOUSEHOLD =====================

async function loadHousehold(voterId, containerEl) {
  var data = await api('/api/captains/' + captainState.captain.id + '/household?voter_id=' + voterId);
  var household = data.household || [];
  if (household.length === 0) return;

  var section = document.createElement('div');
  section.className = 'household-section';
  var h4 = document.createElement('h4');
  h4.textContent = '\uD83C\uDFE0 Other people at this address (' + household.length + ')';
  section.appendChild(h4);

  household.forEach(function(h) {
    var member = document.createElement('div');
    member.className = 'household-member';

    var info = document.createElement('div');
    var memberText = (h.first_name || '') + ' ' + (h.last_name || '');
    if (h.party) memberText += ' \u2022 ' + h.party;
    info.textContent = memberText;

    member.appendChild(info);

    // Household members can always be added to list, even if on another captain's list
    if (captainState.selectedListId) {
      var addBtn = document.createElement('button');
      addBtn.className = 'btn btn-xs btn-captain';
      addBtn.textContent = '+ Add';
      addBtn.addEventListener('click', function() { addVoterToList(h.id); });
      member.appendChild(addBtn);
    }
    section.appendChild(member);
  });

  containerEl.appendChild(section);
}

// ===================== ADD / REMOVE VOTERS =====================

async function addVoterToList(voterId) {
  if (!captainState.selectedListId) {
    alert('Please select a list first from the sidebar.');
    return;
  }
  var data = await api('/api/captains/' + captainState.captain.id + '/lists/' + captainState.selectedListId + '/voters', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ voter_id: voterId })
  });
  if (data.already) {
    alert('This voter is already on this list.');
    return;
  }
  await loadListVoters();
  refreshSidebar();
}

async function removeVoterFromList(voterId) {
  if (!captainState.selectedListId) return;
  await api('/api/captains/' + captainState.captain.id + '/lists/' + captainState.selectedListId + '/voters/' + voterId, {
    method: 'DELETE'
  });
  await loadListVoters();
  refreshSidebar();
}

// ===================== LIST MANAGEMENT =====================

function showNewListModal() {
  var overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.id = 'newListModal';

  var box = document.createElement('div');
  box.className = 'modal-box';

  var h3 = document.createElement('h3');
  h3.textContent = 'Create New List';
  box.appendChild(h3);

  var fg1 = document.createElement('div');
  fg1.className = 'form-group';
  var lbl1 = document.createElement('label');
  lbl1.textContent = 'List Name';
  fg1.appendChild(lbl1);
  var inp = document.createElement('input');
  inp.type = 'text';
  inp.id = 'newListName';
  inp.placeholder = 'e.g., Precinct 42';
  fg1.appendChild(inp);
  box.appendChild(fg1);

  var fg2 = document.createElement('div');
  fg2.className = 'form-group';
  var lbl2 = document.createElement('label');
  lbl2.textContent = 'Assign to Team Member (optional)';
  fg2.appendChild(lbl2);
  var select = document.createElement('select');
  select.id = 'newListTeamMember';
  var defaultOpt = document.createElement('option');
  defaultOpt.value = '';
  defaultOpt.textContent = '-- My List --';
  select.appendChild(defaultOpt);
  // Populate team members
  var members = (captainState.captain.team_members || []);
  members.forEach(function(m) {
    var opt = document.createElement('option');
    opt.value = m.id;
    opt.textContent = m.name;
    select.appendChild(opt);
  });
  fg2.appendChild(select);
  box.appendChild(fg2);

  var btnRow = document.createElement('div');
  btnRow.style.cssText = 'display:flex;gap:8px;margin-top:16px';

  var createBtn = document.createElement('button');
  createBtn.className = 'btn btn-captain';
  createBtn.textContent = 'Create';
  createBtn.addEventListener('click', createList);
  btnRow.appendChild(createBtn);

  var cancelBtn = document.createElement('button');
  cancelBtn.className = 'btn btn-secondary';
  cancelBtn.textContent = 'Cancel';
  cancelBtn.addEventListener('click', function() { closeModal('newListModal'); });
  btnRow.appendChild(cancelBtn);

  box.appendChild(btnRow);
  overlay.appendChild(box);
  document.body.appendChild(overlay);
}

async function createList() {
  var name = document.getElementById('newListName').value.trim();
  if (!name) { alert('Please enter a list name.'); return; }
  var teamMemberId = document.getElementById('newListTeamMember').value || null;

  await api('/api/captains/' + captainState.captain.id + '/lists', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name: name, team_member_id: teamMemberId })
  });
  closeModal('newListModal');
  refreshSidebar();
}

function closeModal(id) {
  var m = document.getElementById(id);
  if (m) m.remove();
}

// ===================== CSV IMPORT =====================

var csvImportState = { rawHeaders: [], autoMap: [], parsedRows: [], importResults: null };

var CAPTAIN_COLUMN_MAP = {
  'firstname': 'first_name', 'first_name': 'first_name', 'first name': 'first_name',
  'first': 'first_name', 'fname': 'first_name', 'givenname': 'first_name',
  'vanfirstname': 'first_name', 'voter first name': 'first_name',
  'lastname': 'last_name', 'last_name': 'last_name', 'last name': 'last_name',
  'last': 'last_name', 'lname': 'last_name', 'surname': 'last_name',
  'vanlastname': 'last_name', 'voter last name': 'last_name',
  'phone': 'phone', 'telephone': 'phone', 'tel': 'phone', 'phonenumber': 'phone',
  'phone_number': 'phone', 'phone number': 'phone', 'cell': 'phone',
  'cellphone': 'phone', 'cell_phone': 'phone', 'mobile': 'phone', 'homephone': 'phone',
  'address': 'address', 'streetaddress': 'address', 'street_address': 'address',
  'street address': 'address', 'addr': 'address', 'street': 'address',
  'address1': 'address', 'mailingaddress': 'address',
  'city': 'city', 'town': 'city', 'municipality': 'city',
  'zip': 'zip', 'zipcode': 'zip', 'zip_code': 'zip', 'zip code': 'zip',
  'postalcode': 'zip', 'postal_code': 'zip', 'postal code': 'zip',
  'registration_number': 'registration_number', 'registration number': 'registration_number',
  'reg number': 'registration_number', 'voter id': 'registration_number',
  'voterid': 'registration_number', 'vanid': 'registration_number',
  'van id': 'registration_number', 'voter_id': 'registration_number',
  'state_id': 'registration_number', 'stateid': 'registration_number',
  'state id': 'registration_number', 'regnum': 'registration_number',
  'reg_num': 'registration_number'
};

var CAPTAIN_CSV_FIELDS = [
  {v: '', l: '-- Skip --'},
  {v: 'first_name', l: 'First Name'},
  {v: 'last_name', l: 'Last Name'},
  {v: 'phone', l: 'Phone'},
  {v: 'address', l: 'Address'},
  {v: 'city', l: 'City'},
  {v: 'zip', l: 'ZIP'},
  {v: 'registration_number', l: 'Registration #'}
];

function parseCsvLine(line) {
  var result = [];
  var current = '';
  var inQuotes = false;
  for (var i = 0; i < line.length; i++) {
    var ch = line[i];
    if (ch === '"') { inQuotes = !inQuotes; }
    else if (ch === ',' && !inQuotes) { result.push(current.trim()); current = ''; }
    else { current += ch; }
  }
  result.push(current.trim());
  return result;
}

function openCsvImportModal() {
  if (!captainState.selectedListId) { alert('Please select a list first.'); return; }

  var overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.id = 'csvImportModal';

  var box = document.createElement('div');
  box.className = 'csv-modal-box';

  var h3 = document.createElement('h3');
  h3.style.cssText = 'margin-bottom:16px;font-size:16px';
  h3.textContent = '\uD83D\uDCC4 Upload CSV to "' + captainState.selectedListName + '"';
  box.appendChild(h3);

  // --- STEP 1: Upload ---
  var step1 = document.createElement('div');
  step1.id = 'csvStep1';
  step1.className = 'csv-step active';

  var desc = document.createElement('p');
  desc.style.cssText = 'color:#94a3b8;font-size:13px;margin-bottom:12px';
  desc.textContent = 'Upload a CSV file or paste CSV data. The system will match rows against the voter database and add matches to your list.';
  step1.appendChild(desc);

  var fg1 = document.createElement('div');
  fg1.className = 'form-group';
  var lbl1 = document.createElement('label');
  lbl1.textContent = 'Choose CSV File';
  fg1.appendChild(lbl1);
  var fileInput = document.createElement('input');
  fileInput.type = 'file';
  fileInput.id = 'csvFileInput';
  fileInput.accept = '.csv,.txt';
  fileInput.style.cssText = 'display:block;margin-top:4px;font-size:13px;color:#94a3b8';
  fg1.appendChild(fileInput);
  step1.appendChild(fg1);

  var fg2 = document.createElement('div');
  fg2.className = 'form-group';
  var lbl2 = document.createElement('label');
  lbl2.textContent = 'Or Paste CSV Data';
  fg2.appendChild(lbl2);
  var ta = document.createElement('textarea');
  ta.id = 'csvPasteArea';
  ta.rows = 6;
  ta.placeholder = 'FirstName,LastName,Phone,Address,City\nJohn,Doe,5125551234,123 Main St,Austin';
  ta.style.cssText = 'width:100%;background:#0f172a;border:1px solid #334155;border-radius:8px;padding:10px;color:#e2e8f0;font-size:13px;font-family:monospace;resize:vertical';
  fg2.appendChild(ta);
  step1.appendChild(fg2);

  var btnRow1 = document.createElement('div');
  btnRow1.style.cssText = 'display:flex;gap:8px;margin-top:12px';
  var previewBtn = document.createElement('button');
  previewBtn.className = 'btn btn-captain';
  previewBtn.textContent = 'Preview & Map Columns';
  previewBtn.addEventListener('click', previewCsvImport);
  btnRow1.appendChild(previewBtn);
  var cancelBtn1 = document.createElement('button');
  cancelBtn1.className = 'btn btn-secondary';
  cancelBtn1.textContent = 'Cancel';
  cancelBtn1.addEventListener('click', closeCsvModal);
  btnRow1.appendChild(cancelBtn1);
  step1.appendChild(btnRow1);
  box.appendChild(step1);

  // --- STEP 2: Column Mapping (populated dynamically) ---
  var step2 = document.createElement('div');
  step2.id = 'csvStep2';
  step2.className = 'csv-step';
  box.appendChild(step2);

  // --- STEP 3: Results (populated dynamically) ---
  var step3 = document.createElement('div');
  step3.id = 'csvStep3';
  step3.className = 'csv-step';
  box.appendChild(step3);

  overlay.appendChild(box);
  document.body.appendChild(overlay);
}

function showCsvStep(n) {
  for (var i = 1; i <= 3; i++) {
    var s = document.getElementById('csvStep' + i);
    if (s) s.className = 'csv-step' + (i === n ? ' active' : '');
  }
}

function closeCsvModal() {
  closeModal('csvImportModal');
  csvImportState = { rawHeaders: [], autoMap: [], parsedRows: [], importResults: null };
  loadListVoters();
  refreshSidebar();
}

function previewCsvImport() {
  var fileInput = document.getElementById('csvFileInput');
  var pasteArea = document.getElementById('csvPasteArea');

  if (fileInput && fileInput.files && fileInput.files.length > 0) {
    var reader = new FileReader();
    reader.onload = function(e) { processCsvText(e.target.result); };
    reader.readAsText(fileInput.files[0]);
  } else if (pasteArea && pasteArea.value.trim()) {
    processCsvText(pasteArea.value.trim());
  } else {
    alert('Please choose a file or paste CSV data.');
  }
}

function processCsvText(text) {
  var lines = text.split(/\r?\n/).filter(function(l) { return l.trim(); });
  if (lines.length < 2) { alert('CSV must have a header row and at least one data row.'); return; }

  csvImportState.rawHeaders = parseCsvLine(lines[0]);
  csvImportState.parsedRows = [];
  for (var i = 1; i < lines.length; i++) {
    csvImportState.parsedRows.push(parseCsvLine(lines[i]));
  }

  // Auto-map columns
  csvImportState.autoMap = csvImportState.rawHeaders.map(function(h) {
    var key = h.toLowerCase().replace(/[^a-z0-9_]/g, '');
    return CAPTAIN_COLUMN_MAP[key] || CAPTAIN_COLUMN_MAP[h.toLowerCase().trim()] || '';
  });

  // Build Step 2 UI
  var step2 = document.getElementById('csvStep2');
  step2.textContent = '';

  var countBadge = document.createElement('div');
  countBadge.style.cssText = 'color:#f59e0b;font-size:14px;font-weight:600;margin-bottom:12px';
  countBadge.textContent = csvImportState.parsedRows.length + ' row' + (csvImportState.parsedRows.length !== 1 ? 's' : '') + ' found';
  step2.appendChild(countBadge);

  // Column mapping
  var mapLabel = document.createElement('div');
  mapLabel.style.cssText = 'font-size:13px;color:#94a3b8;margin-bottom:8px';
  mapLabel.textContent = 'Map each CSV column to a voter field:';
  step2.appendChild(mapLabel);

  var mapContainer = document.createElement('div');
  mapContainer.id = 'csvColumnMapping';
  csvImportState.rawHeaders.forEach(function(h, idx) {
    var row = document.createElement('div');
    row.className = 'csv-col-row';

    var label = document.createElement('div');
    label.className = 'csv-col-label';
    label.textContent = h;
    label.title = h;
    row.appendChild(label);

    var arrow = document.createElement('div');
    arrow.className = 'csv-col-arrow';
    arrow.textContent = '\u2192';
    row.appendChild(arrow);

    var select = document.createElement('select');
    select.className = 'csv-col-select';
    select.dataset.colIdx = idx;
    CAPTAIN_CSV_FIELDS.forEach(function(f) {
      var opt = document.createElement('option');
      opt.value = f.v;
      opt.textContent = f.l;
      if (f.v === csvImportState.autoMap[idx]) opt.selected = true;
      select.appendChild(opt);
    });
    row.appendChild(select);
    mapContainer.appendChild(row);
  });
  step2.appendChild(mapContainer);

  // Preview table (first 5 rows)
  var previewLabel = document.createElement('div');
  previewLabel.style.cssText = 'font-size:13px;color:#94a3b8;margin:12px 0 4px';
  previewLabel.textContent = 'Preview (first 5 rows):';
  step2.appendChild(previewLabel);

  var table = document.createElement('table');
  table.className = 'csv-preview-table';
  var thead = document.createElement('thead');
  var headRow = document.createElement('tr');
  csvImportState.rawHeaders.forEach(function(h) {
    var th = document.createElement('th');
    th.textContent = h;
    headRow.appendChild(th);
  });
  thead.appendChild(headRow);
  table.appendChild(thead);

  var tbody = document.createElement('tbody');
  var previewCount = Math.min(5, csvImportState.parsedRows.length);
  for (var i = 0; i < previewCount; i++) {
    var tr = document.createElement('tr');
    csvImportState.parsedRows[i].forEach(function(cell) {
      var td = document.createElement('td');
      td.textContent = cell;
      td.title = cell;
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  }
  table.appendChild(tbody);
  step2.appendChild(table);

  // Buttons
  var btnRow = document.createElement('div');
  btnRow.style.cssText = 'display:flex;gap:8px;margin-top:16px';
  var importBtn = document.createElement('button');
  importBtn.className = 'btn btn-captain';
  importBtn.textContent = '\uD83D\uDD0D Match & Import';
  importBtn.addEventListener('click', executeCsvImport);
  btnRow.appendChild(importBtn);
  var backBtn = document.createElement('button');
  backBtn.className = 'btn btn-secondary';
  backBtn.textContent = 'Back';
  backBtn.addEventListener('click', function() { showCsvStep(1); });
  btnRow.appendChild(backBtn);
  var cancelBtn = document.createElement('button');
  cancelBtn.className = 'btn btn-secondary';
  cancelBtn.textContent = 'Cancel';
  cancelBtn.addEventListener('click', closeCsvModal);
  btnRow.appendChild(cancelBtn);
  step2.appendChild(btnRow);

  showCsvStep(2);
}

async function executeCsvImport() {
  // Read column mapping
  var selects = document.querySelectorAll('#csvColumnMapping select');
  var colMapping = {};
  for (var i = 0; i < selects.length; i++) {
    if (selects[i].value) {
      colMapping[selects[i].dataset.colIdx] = selects[i].value;
    }
  }

  // Build rows
  var rows = csvImportState.parsedRows.map(function(cols) {
    var row = {};
    for (var idx in colMapping) {
      var field = colMapping[idx];
      row[field] = cols[Number(idx)] || '';
    }
    return row;
  });

  // Filter out rows with no identifying info
  rows = rows.filter(function(r) {
    return (r.first_name && r.last_name) || r.phone || r.registration_number;
  });

  if (rows.length === 0) { alert('No usable rows found. Make sure at least name or phone is mapped.'); return; }

  // Disable button
  var btn = document.querySelector('#csvStep2 .btn-captain');
  if (btn) { btn.disabled = true; btn.textContent = 'Matching...'; }

  try {
    var data = await api('/api/captains/' + captainState.captain.id + '/lists/' + captainState.selectedListId + '/import-csv', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ rows: rows })
    });

    if (!data.success) { alert('Import failed: ' + (data.error || 'Unknown error')); return; }

    csvImportState.importResults = data;
    buildResultsStep(data);
    showCsvStep(3);
  } catch(e) {
    alert('Import failed: ' + (e.message || 'Unknown error'));
  } finally {
    if (btn) { btn.disabled = false; btn.textContent = '\uD83D\uDD0D Match & Import'; }
  }
}

function buildResultsStep(data) {
  var step3 = document.getElementById('csvStep3');
  step3.textContent = '';

  var h = document.createElement('h3');
  h.style.cssText = 'margin-bottom:16px;font-size:16px';
  h.textContent = 'Import Results';
  step3.appendChild(h);

  // Section 1: Auto-matched (green)
  var autoSection = document.createElement('div');
  autoSection.className = 'csv-result-section csv-result-auto';
  var autoTitle = document.createElement('div');
  autoTitle.style.cssText = 'font-weight:600;font-size:14px;color:#22c55e;margin-bottom:4px';
  autoTitle.textContent = '\u2705 Auto-matched: ' + data.auto_added + ' voter' + (data.auto_added !== 1 ? 's' : '') + ' added to list';
  autoSection.appendChild(autoTitle);
  if (data.already_on_list > 0) {
    var alreadyNote = document.createElement('div');
    alreadyNote.style.cssText = 'font-size:12px;color:#94a3b8';
    alreadyNote.textContent = '(' + data.already_on_list + ' already on list — skipped)';
    autoSection.appendChild(alreadyNote);
  }
  step3.appendChild(autoSection);

  // Section 2: Needs Review (amber)
  if (data.needs_review && data.needs_review.length > 0) {
    var reviewSection = document.createElement('div');
    reviewSection.className = 'csv-result-section csv-result-review';
    var reviewTitle = document.createElement('div');
    reviewTitle.style.cssText = 'font-weight:600;font-size:14px;color:#f59e0b;margin-bottom:8px';
    reviewTitle.textContent = '\u26A0\uFE0F Needs Verification: ' + data.needs_review.length + ' row' + (data.needs_review.length !== 1 ? 's' : '');
    reviewSection.appendChild(reviewTitle);
    var reviewDesc = document.createElement('div');
    reviewDesc.style.cssText = 'font-size:12px;color:#94a3b8;margin-bottom:12px';
    reviewDesc.textContent = 'Multiple potential matches found. Select the correct voter for each row, or skip.';
    reviewSection.appendChild(reviewDesc);

    var reviewContainer = document.createElement('div');
    reviewContainer.id = 'csvReviewContainer';

    data.needs_review.forEach(function(item, idx) {
      var card = document.createElement('div');
      card.className = 'csv-review-item';

      // CSV row info
      var csvInfo = document.createElement('div');
      csvInfo.className = 'csv-review-csv-row';
      csvInfo.textContent = 'CSV: ' + (item.csv_row.first_name || '') + ' ' + (item.csv_row.last_name || '') +
        (item.csv_row.phone ? ' \u2022 ' + item.csv_row.phone : '') +
        (item.csv_row.address ? ' \u2022 ' + item.csv_row.address : '');
      card.appendChild(csvInfo);

      // Candidates as radio buttons
      item.candidates.forEach(function(c, cIdx) {
        var label = document.createElement('label');
        label.className = 'csv-review-candidate';

        var radio = document.createElement('input');
        radio.type = 'radio';
        radio.name = 'csvReview_' + idx;
        radio.value = c.id;
        label.appendChild(radio);

        var info = document.createElement('span');
        info.textContent = c.first_name + ' ' + c.last_name +
          (c.phone ? ' \u2022 ' + c.phone : '') +
          (c.address ? ' \u2022 ' + c.address : '') +
          (c.party ? ' (' + c.party + ')' : '');
        label.appendChild(info);
        card.appendChild(label);
      });

      // Skip option (pre-selected)
      var skipLabel = document.createElement('label');
      skipLabel.className = 'csv-review-candidate';
      var skipRadio = document.createElement('input');
      skipRadio.type = 'radio';
      skipRadio.name = 'csvReview_' + idx;
      skipRadio.value = '';
      skipRadio.checked = true;
      skipLabel.appendChild(skipRadio);
      var skipText = document.createElement('span');
      skipText.style.color = '#64748b';
      skipText.textContent = 'Skip — none of these';
      skipLabel.appendChild(skipText);
      card.appendChild(skipLabel);

      reviewContainer.appendChild(card);
    });

    reviewSection.appendChild(reviewContainer);

    var confirmBtn = document.createElement('button');
    confirmBtn.className = 'btn btn-captain';
    confirmBtn.id = 'btnConfirmMatches';
    confirmBtn.style.marginTop = '12px';
    confirmBtn.textContent = 'Confirm Selected Matches';
    confirmBtn.addEventListener('click', confirmCsvMatches);
    reviewSection.appendChild(confirmBtn);

    step3.appendChild(reviewSection);
  }

  // Section 3: No match (gray)
  if (data.no_match && data.no_match.length > 0) {
    var noneSection = document.createElement('div');
    noneSection.className = 'csv-result-section csv-result-none';
    var noneTitle = document.createElement('div');
    noneTitle.style.cssText = 'font-weight:600;font-size:14px;color:#94a3b8;margin-bottom:4px';
    noneTitle.textContent = '\u274C No match found: ' + data.no_match.length + ' row' + (data.no_match.length !== 1 ? 's' : '');
    noneSection.appendChild(noneTitle);
    var noneNote = document.createElement('div');
    noneNote.style.cssText = 'font-size:12px;color:#64748b;margin-bottom:4px';
    noneNote.textContent = 'These names were not found in the voter database.';
    noneSection.appendChild(noneNote);

    // List unmatched names
    data.no_match.forEach(function(nm) {
      var row = document.createElement('div');
      row.style.cssText = 'font-size:12px;color:#94a3b8;padding:2px 0';
      row.textContent = '\u2022 ' + (nm.first_name || '') + ' ' + (nm.last_name || '') +
        (nm.phone ? ' (' + nm.phone + ')' : '');
      noneSection.appendChild(row);
    });
    step3.appendChild(noneSection);
  }

  // Done button
  var btnRow = document.createElement('div');
  btnRow.style.cssText = 'display:flex;gap:8px;margin-top:16px';
  var doneBtn = document.createElement('button');
  doneBtn.className = 'btn btn-secondary';
  doneBtn.textContent = 'Done';
  doneBtn.addEventListener('click', closeCsvModal);
  btnRow.appendChild(doneBtn);
  step3.appendChild(btnRow);
}

async function confirmCsvMatches() {
  var results = csvImportState.importResults;
  if (!results || !results.needs_review) return;

  var matches = [];
  for (var i = 0; i < results.needs_review.length; i++) {
    var selected = document.querySelector('input[name="csvReview_' + i + '"]:checked');
    if (selected && selected.value) {
      matches.push({ voter_id: parseInt(selected.value) });
    }
  }

  if (matches.length === 0) {
    alert('No matches selected. All rows will be skipped.');
    return;
  }

  var btn = document.getElementById('btnConfirmMatches');
  if (btn) { btn.disabled = true; btn.textContent = 'Confirming...'; }

  try {
    var data = await api('/api/captains/' + captainState.captain.id + '/lists/' + captainState.selectedListId + '/confirm-matches', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ matches: matches })
    });

    if (data.success) {
      alert('Added ' + data.added + ' voter' + (data.added !== 1 ? 's' : '') + ' to list.' + (data.already > 0 ? ' (' + data.already + ' already on list)' : ''));
      if (btn) { btn.textContent = '\u2705 Confirmed!'; btn.disabled = true; }
      // Disable all radio buttons
      var radios = document.querySelectorAll('#csvReviewContainer input[type=radio]');
      for (var r = 0; r < radios.length; r++) { radios[r].disabled = true; }
    } else {
      alert('Confirmation failed: ' + (data.error || 'Unknown error'));
      if (btn) { btn.disabled = false; btn.textContent = 'Confirm Selected Matches'; }
    }
  } catch(e) {
    alert('Confirmation failed: ' + (e.message || 'Unknown error'));
    if (btn) { btn.disabled = false; btn.textContent = 'Confirm Selected Matches'; }
  }
}

// ===================== TEAM MANAGEMENT =====================

async function addTeamMember() {
  var name = prompt('Enter team member name:');
  if (!name || !name.trim()) return;

  var data = await api('/api/captains/' + captainState.captain.id + '/team', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name: name.trim() })
  });
  if (data.success) {
    // Refresh captain data to get updated team members
    var loginData = await api('/api/captains/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ code: captainState.captain.code })
    });
    if (loginData.captain) {
      captainState.captain = loginData.captain;
    }
    alert('Team member "' + name.trim() + '" added!');
  }
}
</script>
</body>
</html>
