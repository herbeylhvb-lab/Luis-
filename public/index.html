<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Campaign Text HQ</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#0f172a;color:#e2e8f0;display:flex;min-height:100vh}
a{color:#818cf8;text-decoration:none}
/* Sidebar */
.sidebar{width:220px;background:#1e293b;border-right:1px solid #334155;display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:10}
.sidebar-logo{padding:20px;font-size:18px;font-weight:700;color:#818cf8;border-bottom:1px solid #334155}
.sidebar-logo span{color:#f472b6}
.sidebar-section{padding:12px 16px 4px;font-size:11px;font-weight:600;color:#64748b;text-transform:uppercase;letter-spacing:1px}
.sidebar-nav{flex:1;overflow-y:auto}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 20px;cursor:pointer;transition:background .15s;font-size:14px;color:#94a3b8}
.nav-item:hover{background:#334155}
.nav-item.active{background:#334155;color:#818cf8;border-right:3px solid #818cf8}
.nav-item .icon{width:20px;text-align:center}
.conn-status{padding:16px 20px;border-top:1px solid #334155;font-size:12px}
.conn-dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:6px}
.conn-dot.off{background:#ef4444}
.conn-dot.on{background:#22c55e}
/* Main */
.main{margin-left:220px;flex:1;display:flex;flex-direction:column;min-height:100vh}
.topbar{background:#1e293b;border-bottom:1px solid #334155;padding:14px 24px;display:flex;align-items:center;justify-content:space-between}
.topbar h2{font-size:18px;font-weight:600}
.content{flex:1;padding:24px;overflow-y:auto}
/* Cards */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:16px;margin-bottom:24px}
.stat-card{background:#1e293b;border:1px solid #334155;border-radius:12px;padding:20px}
.stat-card .label{font-size:12px;color:#64748b;text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px}
.stat-card .value{font-size:28px;font-weight:700;color:#f8fafc}
.stat-card .sub{font-size:12px;color:#64748b;margin-top:4px}
.card{background:#1e293b;border:1px solid #334155;border-radius:12px;padding:24px;margin-bottom:20px}
.card h3{margin-bottom:16px;font-size:16px;font-weight:600}
/* Forms */
.form-group{margin-bottom:16px}
.form-group label{display:block;font-size:13px;color:#94a3b8;margin-bottom:6px;font-weight:500}
.form-group input,.form-group textarea,.form-group select{width:100%;background:#0f172a;border:1px solid #334155;border-radius:8px;padding:10px 14px;color:#e2e8f0;font-size:14px;outline:none;transition:border .2s}
.form-group input:focus,.form-group textarea:focus,.form-group select:focus{border-color:#818cf8}
.form-group textarea{resize:vertical;min-height:100px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.form-row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
/* Buttons */
.btn{display:inline-flex;align-items:center;gap:6px;padding:10px 20px;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;transition:opacity .15s}
.btn:hover{opacity:.85}
.btn:disabled{opacity:.5;cursor:not-allowed}
.btn-primary{background:#818cf8;color:#fff}
.btn-success{background:#22c55e;color:#fff}
.btn-danger{background:#ef4444;color:#fff}
.btn-secondary{background:#334155;color:#e2e8f0}
.btn-warning{background:#f59e0b;color:#000}
.btn-sm{padding:6px 14px;font-size:13px}
.btn-xs{padding:4px 10px;font-size:12px}
/* Table */
.table-wrap{overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:14px}
th{text-align:left;padding:10px 12px;background:#0f172a;color:#64748b;font-size:12px;text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid #334155}
td{padding:10px 12px;border-bottom:1px solid #1e293b}
tr:hover td{background:#1e293b80}
/* Alerts */
.alert{padding:12px 16px;border-radius:8px;margin-bottom:16px;font-size:14px}
.alert-success{background:#052e16;border:1px solid #166534;color:#4ade80}
.alert-error{background:#450a0a;border:1px solid #991b1b;color:#fca5a5}
.alert-info{background:#0c1a3d;border:1px solid #1e3a5f;color:#93c5fd}
/* Badge */
.badge{display:inline-block;padding:2px 8px;border-radius:9999px;font-size:11px;font-weight:600}
.badge-green{background:#052e16;color:#4ade80}
.badge-red{background:#450a0a;color:#fca5a5}
.badge-yellow{background:#422006;color:#fcd34d}
.badge-blue{background:#0c1a3d;color:#93c5fd}
.badge-purple{background:#2e1065;color:#c4b5fd}
.badge-gray{background:#1e293b;color:#94a3b8}
/* Message bubbles */
.msg-list{max-height:400px;overflow-y:auto}
.msg-item{padding:12px;border-bottom:1px solid #334155}
.msg-item .phone{font-weight:600;color:#818cf8;font-size:13px}
.msg-item .body{margin-top:4px;color:#e2e8f0}
.msg-item .time{font-size:11px;color:#64748b;margin-top:4px}
.msg-item .reply-box{margin-top:8px;display:flex;gap:8px}
.msg-item .reply-box input{flex:1}
/* Activity log */
.log-entry{padding:8px 0;border-bottom:1px solid #334155;font-size:13px;color:#94a3b8}
.log-entry .log-time{color:#64748b;font-size:11px}
/* Progress bar */
.progress-bar{background:#334155;border-radius:8px;height:12px;overflow:hidden;margin:8px 0}
.progress-fill{height:100%;border-radius:8px;transition:width .3s}
.progress-fill.green{background:#22c55e}
.progress-fill.blue{background:#818cf8}
/* Back button */
.back-btn{cursor:pointer;color:#818cf8;font-size:14px;margin-bottom:16px;display:inline-flex;align-items:center;gap:4px}
.back-btn:hover{text-decoration:underline}
/* Inline select */
.inline-select{background:#0f172a;border:1px solid #334155;border-radius:6px;padding:4px 8px;color:#e2e8f0;font-size:12px}
/* Event cards */
.event-card{background:#0f172a;border:1px solid #334155;border-radius:12px;padding:20px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center}
.event-card .event-info h4{font-size:16px;margin-bottom:4px}
.event-card .event-meta{font-size:13px;color:#94a3b8}
/* Checkbox list */
.check-list{max-height:200px;overflow-y:auto;border:1px solid #334155;border-radius:8px;padding:8px}
.check-item{display:flex;align-items:center;gap:8px;padding:4px 8px;font-size:13px}
.check-item input[type=checkbox]{accent-color:#818cf8}
/* Hide pages */
.page{display:none}
.page.active{display:block}
/* Responsive */
@media(max-width:768px){
  .sidebar{width:60px}
  .sidebar-logo,.sidebar-section,.nav-item span:not(.icon){display:none}
  .nav-item{justify-content:center;padding:12px}
  .main{margin-left:60px}
  .form-row,.form-row-3{grid-template-columns:1fr}
  .stats-grid{grid-template-columns:1fr 1fr}
}
/* Sentiment badges */
.sentiment-positive{color:#4ade80}
.sentiment-negative{color:#fca5a5}
.sentiment-neutral{color:#94a3b8}
/* QR Modal */
.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:100}
.modal-box{background:#1e293b;border:1px solid #334155;border-radius:16px;padding:32px;max-width:400px;width:90%;text-align:center}
.modal-box h3{margin-bottom:16px}
.modal-box canvas{margin:16px auto;display:block;border-radius:8px}
.modal-close{position:absolute;top:12px;right:16px;background:none;border:none;color:#94a3b8;font-size:24px;cursor:pointer}
</style>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
</head>
<body>

<div class="sidebar">
  <div class="sidebar-logo">Campaign<span>Text</span> HQ</div>
  <div class="sidebar-nav">
    <div class="sidebar-section">Campaign</div>
    <div class="nav-item active" data-page="dashboard"><span class="icon">&#128202;</span><span>Dashboard</span></div>
    <div class="nav-item" data-page="compose"><span class="icon">&#9993;&#65039;</span><span>Compose &amp; Send</span></div>
    <div class="nav-item" data-page="contacts"><span class="icon">&#128101;</span><span>Contacts</span></div>
    <div class="sidebar-section">Field</div>
    <div class="nav-item" data-page="walks"><span class="icon">&#128694;</span><span>Block Walk</span></div>
    <div class="nav-item" data-page="voters"><span class="icon">&#128209;</span><span>Voter File</span></div>
    <div class="nav-item" data-page="events"><span class="icon">&#128197;</span><span>Events</span></div>
    <div class="sidebar-section">Responses</div>
    <div class="nav-item" data-page="inbox"><span class="icon">&#128172;</span><span>Inbox</span></div>
    <div class="sidebar-section">System</div>
    <div class="nav-item" data-page="twilio"><span class="icon">&#128273;</span><span>Twilio Setup</span></div>
    <div class="nav-item" data-page="autoreply"><span class="icon">&#129302;</span><span>Auto-Reply AI</span></div>
    <div class="sidebar-section">P2P</div>
    <div class="nav-item" data-page="p2p"><span class="icon">&#128241;</span><span>P2P Texting</span></div>
    <div class="nav-item" data-page="knowledge"><span class="icon">&#128218;</span><span>Knowledge Base</span></div>
  </div>
  <div class="conn-status" id="connStatus">
    <span class="conn-dot off" id="connDot"></span>
    <span id="connLabel">Not Connected</span>
  </div>
</div>

<div class="main">
  <div class="topbar">
    <h2 id="pageTitle">Dashboard</h2>
    <div style="font-size:12px;color:#64748b" id="lastUpdated"></div>
  </div>
  <div class="content">

    <!-- ==================== DASHBOARD ==================== -->
    <div class="page active" id="page-dashboard">
      <div class="stats-grid">
        <div class="stat-card"><div class="label">Total Sent</div><div class="value" id="statSent">0</div><div class="sub">Across all campaigns</div></div>
        <div class="stat-card"><div class="label">Responses</div><div class="value" id="statResponses">0</div><div class="sub" id="statResponseRate">0% response rate</div></div>
        <div class="stat-card"><div class="label">Contacts</div><div class="value" id="statContacts">0</div><div class="sub">Loaded in system</div></div>
        <div class="stat-card"><div class="label">Doors Knocked</div><div class="value" id="statDoors">0</div><div class="sub" id="statWalks">0 block walks</div></div>
        <div class="stat-card"><div class="label">Voter File</div><div class="value" id="statVoters">0</div><div class="sub">Voters loaded</div></div>
        <div class="stat-card"><div class="label">Events</div><div class="value" id="statEvents">0</div><div class="sub">Upcoming</div></div>
        <div class="stat-card"><div class="label">Sentiment</div><div class="value" style="font-size:16px" id="statSentiment">--</div><div class="sub">Response mood</div></div>
      </div>
      <div class="card">
        <h3>Campaign Activity Log</h3>
        <div id="activityLog"><div class="log-entry" style="color:#64748b">No activity yet.</div></div>
      </div>
    </div>

    <!-- ==================== TWILIO SETUP ==================== -->
    <div class="page" id="page-twilio">
      <div class="card">
        <h3>Twilio Configuration</h3>
        <p style="color:#94a3b8;margin-bottom:16px;font-size:14px">Enter your Twilio credentials to connect. Find them at console.twilio.com.</p>
        <div id="twilioAlert"></div>
        <div class="form-group"><label>Account SID</label><input type="text" id="accountSid" placeholder="ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"></div>
        <div class="form-group"><label>Auth Token</label><input type="password" id="authToken" placeholder="Your auth token"></div>
        <div class="form-group"><label>From Phone Number</label><input type="text" id="fromNumber" placeholder="+1234567890"></div>
        <button class="btn btn-primary" id="btnTestConnection">Test Connection</button>
        <button class="btn btn-secondary" id="btnSaveCredentials" style="margin-left:8px">Save Credentials</button>
      </div>
    </div>

    <!-- ==================== CONTACTS ==================== -->
    <div class="page" id="page-contacts">
      <div class="card">
        <h3>Manage Contacts</h3>
        <p style="color:#94a3b8;margin-bottom:16px;font-size:14px">Add contacts manually or paste from a CSV. Required: phone. Optional: firstName, lastName, city.</p>
        <div class="form-row" style="margin-bottom:16px">
          <div class="form-group"><label>Phone</label><input type="text" id="cPhone" placeholder="+1234567890"></div>
          <div class="form-group"><label>First Name</label><input type="text" id="cFirst" placeholder="John"></div>
        </div>
        <div class="form-row" style="margin-bottom:16px">
          <div class="form-group"><label>Last Name</label><input type="text" id="cLast" placeholder="Doe"></div>
          <div class="form-group"><label>City</label><input type="text" id="cCity" placeholder="Austin"></div>
        </div>
        <button class="btn btn-primary btn-sm" id="btnAddContact">Add Contact</button>
        <button class="btn btn-secondary btn-sm" id="btnImportCSV" style="margin-left:8px">Paste CSV Import</button>
      </div>
      <div class="card" id="csvImportCard" style="display:none">
        <h3>CSV Import</h3>
        <p style="color:#94a3b8;margin-bottom:12px;font-size:13px">Paste CSV with headers: phone, firstName, lastName, city (one per line).</p>
        <div class="form-group"><textarea id="csvData" rows="8" placeholder="phone,firstName,lastName,city&#10;+15125551234,John,Doe,Austin"></textarea></div>
        <button class="btn btn-success btn-sm" id="btnParseCSV">Import Contacts</button>
        <button class="btn btn-secondary btn-sm" id="btnCancelCSV" style="margin-left:8px">Cancel</button>
      </div>
      <div class="card">
        <h3>Contact List <span class="badge badge-green" id="contactCount">0</span></h3>
        <div class="table-wrap"><table><thead><tr><th>Phone</th><th>First Name</th><th>Last Name</th><th>City</th><th>Actions</th></tr></thead><tbody id="contactsBody"></tbody></table></div>
        <div style="margin-top:12px"><button class="btn btn-danger btn-sm" id="btnClearContacts">Clear All</button></div>
      </div>
    </div>

    <!-- ==================== COMPOSE & SEND ==================== -->
    <div class="page" id="page-compose">
      <div class="card">
        <h3>Compose Campaign Message</h3>
        <div id="composeAlert"></div>
        <div class="alert alert-info">Use <strong>{firstName}</strong>, <strong>{lastName}</strong>, <strong>{city}</strong> as merge tags.</div>
        <div class="form-group"><label>Message Template</label><textarea id="messageTemplate" placeholder="Hi {firstName}! This is a reminder about the upcoming event in {city}."></textarea></div>
        <div class="form-group"><label>Opt-Out Footer</label><input type="text" id="optOutFooter" value="Reply STOP to opt out."></div>
        <div style="margin-bottom:16px"><div style="font-size:13px;color:#94a3b8">Sending to: <strong id="sendToCount">0</strong> contacts</div></div>
        <button class="btn btn-success" id="btnSendCampaign">Send Campaign</button>
      </div>
      <div class="card" id="sendResultCard" style="display:none">
        <h3>Send Results</h3>
        <div id="sendResults"></div>
      </div>
    </div>

    <!-- ==================== INBOX ==================== -->
    <div class="page" id="page-inbox">
      <div class="card">
        <h3>Incoming Messages</h3>
        <button class="btn btn-secondary btn-sm" id="btnRefreshInbox" style="margin-bottom:16px">Refresh</button>
        <div class="msg-list" id="inboxMessages"><div style="color:#64748b;font-size:14px">No messages yet.</div></div>
      </div>
      <div class="card">
        <h3>Opted Out Numbers</h3>
        <div id="optedOutList" style="color:#64748b;font-size:14px">No opted-out numbers.</div>
      </div>
    </div>

    <!-- ==================== AUTO-REPLY ==================== -->
    <div class="page" id="page-autoreply">
      <div class="card">
        <h3>Auto-Reply AI Settings</h3>
        <p style="color:#94a3b8;margin-bottom:16px;font-size:14px">The system automatically replies to common keywords.</p>
        <div class="table-wrap"><table><thead><tr><th>Keywords</th><th>Auto-Reply Message</th></tr></thead><tbody>
          <tr><td><span class="badge badge-green">poll, polling, vote, where, location</span></td><td>Find your polling location at vote.gov.</td></tr>
          <tr><td><span class="badge badge-green">time, open, close, hours, when</span></td><td>Polls are open 7:00 AM - 7:00 PM on Election Day.</td></tr>
          <tr><td><span class="badge badge-green">register, registration</span></td><td>Register or check your status at vote.org.</td></tr>
          <tr><td><span class="badge badge-yellow">stop, unsubscribe, cancel, quit, end</span></td><td>You've been removed from our list. (Auto opt-out)</td></tr>
        </tbody></table></div>
      </div>
    </div>

    <!-- ================= KNOWLEDGE BASE ================= -->
    <div class="page" id="page-knowledge">
      <div class="card">
        <h3>AI Settings</h3>
        <div class="form-group"><label>Anthropic API Key</label><input type="password" id="anthropicKey" placeholder="sk-ant-..."></div>
        <button class="btn btn-primary btn-sm" id="btnSaveApiKey">Save API Key</button>
        <span id="apiKeyStatus" style="margin-left:12px;font-size:13px;color:#64748b"></span>
      </div>
      <div class="card">
        <h3>Campaign Details</h3>
        <div class="form-row" style="margin-bottom:16px">
          <div class="form-group"><label>Campaign Name</label><input type="text" id="kdCampaignName" placeholder="Santos for District 4"></div>
          <div class="form-group"><label>Election Date</label><input type="date" id="kdElectionDate"></div>
        </div>
        <div class="form-row" style="margin-bottom:16px">
          <div class="form-group"><label>Website</label><input type="text" id="kdWebsite" placeholder="https://campaign.com"></div>
          <div class="form-group"><label>Key Message / Slogan</label><input type="text" id="kdSlogan" placeholder="Putting families first"></div>
        </div>
        <button class="btn btn-primary btn-sm" id="btnSaveCampaignDetails">Save Details</button>
      </div>
      <div class="card">
        <h3>Candidate Bio</h3>
        <div class="form-group"><textarea id="kdBio" rows="4" placeholder="Background, qualifications, experience..."></textarea></div>
        <button class="btn btn-primary btn-sm" id="btnSaveBio">Save Bio</button>
      </div>
      <div class="card">
        <h3>Policy Positions <button class="btn btn-primary btn-xs" style="margin-left:12px" id="btnAddPolicy">+ Add Policy</button></h3>
        <div id="policiesList"></div>
      </div>
      <div class="card">
        <h3>Response Scripts <button class="btn btn-primary btn-xs" style="margin-left:12px" id="btnAddScript">+ Add Script</button></h3>
        <p style="color:#94a3b8;margin-bottom:12px;font-size:13px">Fallback responses when AI can't generate a confident reply.</p>
        <div id="scriptsList"></div>
      </div>
    </div>

    <!-- ================= P2P TEXTING ================= -->
    <div class="page" id="page-p2p">
      <div id="p2p-admin-view">
        <div class="card">
          <h3>Create P2P Session</h3>
          <div class="form-row" style="margin-bottom:16px">
            <div class="form-group"><label>Session Name</label><input type="text" id="p2pSessionName" placeholder="Voter Outreach Oct"></div>
            <div class="form-group"><label>Assignment Mode</label>
              <select id="p2pAssignMode" style="width:100%;background:#0f172a;border:1px solid #334155;border-radius:8px;padding:10px 14px;color:#e2e8f0;font-size:14px">
                <option value="auto_split">Auto-Split (even distribution)</option>
                <option value="claim">Claim-Based (first-come)</option>
                <option value="manual">Manual Assign</option>
              </select>
            </div>
          </div>
          <div class="form-group"><label>Message Template</label><textarea id="p2pTemplate" rows="3" placeholder="Hi {firstName}! This is a volunteer with the campaign..."></textarea></div>
          <div class="form-group"><label>Select Contacts</label>
            <div style="margin-bottom:8px"><button class="btn btn-secondary btn-xs" id="btnP2pSelectAll">Select All</button> <button class="btn btn-secondary btn-xs" id="btnP2pSelectNone">Select None</button> <span style="margin-left:8px;font-size:13px;color:#94a3b8" id="p2pSelectedCount">0 selected</span></div>
            <div class="check-list" id="p2pContactList"></div>
          </div>
          <button class="btn btn-success" id="btnCreateP2pSession">Create Session</button>
        </div>
        <div class="card">
          <h3>Active Sessions</h3>
          <div id="p2pSessionsList"></div>
        </div>
      </div>
      <div id="p2p-session-view" style="display:none">
        <div class="back-btn" onclick="showP2pAdmin()">&#8592; Back to Sessions</div>
        <div class="card">
          <h3 id="p2pSessionTitle">Session</h3>
          <div style="display:flex;gap:16px;margin-bottom:16px;font-size:14px;flex-wrap:wrap">
            <span>Join Code: <strong id="p2pJoinCodeDisplay" style="color:#818cf8;font-size:18px">----</strong></span>
            <span>Expires: <span id="p2pCodeExpires" style="color:#94a3b8"></span></span>
            <span>Mode: <select class="inline-select" id="p2pModeSelect" onchange="updateP2pMode()"></select></span>
          </div>
          <div class="stats-grid" style="margin-bottom:16px">
            <div class="stat-card"><div class="label">Total Sent</div><div class="value" id="p2pStatSent">0</div></div>
            <div class="stat-card"><div class="label">Active Chats</div><div class="value" id="p2pStatChats">0</div></div>
            <div class="stat-card"><div class="label">Remaining</div><div class="value" id="p2pStatRemaining">0</div></div>
          </div>
          <h3>Volunteers</h3>
          <div class="table-wrap"><table><thead><tr><th>Name</th><th>Status</th><th>Sent</th><th>Active Chats</th><th>Remaining</th></tr></thead><tbody id="p2pVolunteersBody"></tbody></table></div>
          <div style="margin-top:12px"><button class="btn btn-danger btn-sm" id="btnCloseSession">Close Session</button></div>
        </div>
      </div>
      <div id="p2p-volunteer-view" style="display:none">
        <div class="back-btn" onclick="leaveP2pVolunteer()">&#8592; Leave Session</div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:8px">
          <div><strong id="p2pVolName" style="color:#818cf8"></strong> &middot; <span id="p2pVolSession" style="color:#94a3b8"></span></div>
          <div style="display:flex;gap:8px;align-items:center">
            <span id="p2pVolProgress" style="font-size:13px;color:#94a3b8"></span>
            <button class="btn btn-secondary btn-sm" id="btnToggleOnline">Go Offline</button>
          </div>
        </div>
        <div class="card" id="p2pQueueCard">
          <div id="p2pContactInfo" style="margin-bottom:16px"></div>
          <div class="form-group"><label>Message</label><textarea id="p2pMessage" rows="4"></textarea></div>
          <div style="display:flex;gap:8px">
            <button class="btn btn-success" id="btnP2pSend">&#9654; Send</button>
            <button class="btn btn-secondary" id="btnP2pSkip">&#9197; Skip</button>
          </div>
        </div>
        <div class="card" id="p2pConversationsCard" style="display:none">
          <h3>Active Conversations <span class="badge badge-blue" id="p2pConvCount">0</span></h3>
          <div id="p2pConversationsList"></div>
        </div>
        <div class="card" id="p2pReplyCard" style="display:none">
          <div class="back-btn" onclick="closeP2pReply()">&#8592; Back to Queue</div>
          <h3 id="p2pReplyHeader">Conversation</h3>
          <div class="msg-list" id="p2pThread"></div>
          <div id="p2pSuggestion" style="margin-top:12px;display:none">
            <div style="font-size:12px;color:#64748b;margin-bottom:4px">&#129302; AI Suggested Reply <span id="p2pSuggestionSource" class="badge badge-gray"></span></div>
            <div style="background:#0f172a;border:1px solid #334155;border-radius:8px;padding:10px 14px;font-size:14px;color:#e2e8f0" id="p2pSuggestionText"></div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button class="btn btn-success btn-sm" id="btnApproveSuggestion">&#9989; Approve &amp; Send</button>
              <button class="btn btn-secondary btn-sm" id="btnEditSuggestion">&#9998; Edit</button>
              <button class="btn btn-warning btn-sm" id="btnWriteOwn">Write Own</button>
            </div>
          </div>
          <div id="p2pManualReply" style="margin-top:12px">
            <div class="form-group"><textarea id="p2pReplyText" rows="2" placeholder="Type your reply..."></textarea></div>
            <div style="display:flex;gap:8px">
              <button class="btn btn-success btn-sm" id="btnSendReply">Send Reply</button>
              <button class="btn btn-secondary btn-sm" id="btnMarkComplete">Mark Complete</button>
            </div>
          </div>
        </div>
      </div>
      <div class="card" id="p2pJoinCard">
        <h3>Join a P2P Session</h3>
        <p style="color:#94a3b8;margin-bottom:16px;font-size:14px">Enter the 4-digit code from your campaign admin to start texting.</p>
        <div class="form-row" style="margin-bottom:16px">
          <div class="form-group"><label>Your Name</label><input type="text" id="p2pJoinName" placeholder="Maria"></div>
          <div class="form-group"><label>Join Code</label><input type="text" id="p2pJoinCode" placeholder="1234" maxlength="4"></div>
        </div>
        <button class="btn btn-primary" id="btnJoinP2p">Join Session</button>
      </div>
    </div>

    <!-- ==================== BLOCK WALK ==================== -->
    <div class="page" id="page-walks">
      <!-- WALK LIST VIEW -->
      <div id="walks-list-view">
        <div class="card">
          <h3>Block Walk / Canvassing</h3>
          <p style="color:#94a3b8;margin-bottom:16px;font-size:14px">Create walk lists, assign volunteers, and track door-knock results.</p>
          <div class="form-row" style="margin-bottom:16px">
            <div class="form-group"><label>Walk Name</label><input type="text" id="walkName" placeholder="Precinct 42 - Main St"></div>
            <div class="form-group"><label>Assign To</label><input type="text" id="walkAssign" placeholder="Volunteer name"></div>
          </div>
          <div class="form-group"><label>Description</label><input type="text" id="walkDesc" placeholder="3 blocks around Main & 5th"></div>
          <button class="btn btn-primary" id="btnCreateWalk">Create Walk</button>
        </div>
        <div class="card">
          <h3>Walk Lists</h3>
          <div class="table-wrap"><table><thead><tr><th>Name</th><th>Assigned To</th><th>Status</th><th>Progress</th><th>Actions</th></tr></thead><tbody id="walksBody"></tbody></table></div>
        </div>
      </div>
      <!-- WALK DETAIL VIEW -->
      <div id="walks-detail-view" style="display:none">
        <div class="back-btn" onclick="showWalkList()">&#8592; Back to Walks</div>
        <div class="card">
          <h3 id="walkDetailName"></h3>
          <div class="form-row" style="margin-bottom:16px">
            <div><strong style="color:#94a3b8;font-size:13px">Assigned to:</strong> <span id="walkDetailAssign"></span></div>
            <div><strong style="color:#94a3b8;font-size:13px">Status:</strong> <select class="inline-select" id="walkDetailStatus" onchange="updateWalkStatus()"><option value="pending">Pending</option><option value="in_progress">In Progress</option><option value="completed">Completed</option></select></div>
          </div>
          <div class="stats-grid" id="walkResultStats"></div>
          <div class="progress-bar"><div class="progress-fill green" id="walkProgress" style="width:0%"></div></div>
          <div style="font-size:12px;color:#64748b;margin-bottom:16px" id="walkProgressLabel">0 / 0 doors knocked</div>
        </div>
        <div class="card">
          <h3>Add Addresses</h3>
          <p style="color:#94a3b8;margin-bottom:12px;font-size:13px">Paste addresses, one per line. Format: address, unit, city, zip, voter name (only address is required).</p>
          <div class="form-group"><textarea id="walkAddressInput" rows="5" placeholder="123 Main St, , Austin, 78701, John Doe&#10;456 Oak Ave, Apt 2, Austin, 78701, Jane Smith"></textarea></div>
          <button class="btn btn-success btn-sm" id="btnAddWalkAddresses">Add Addresses</button>
        </div>
        <div class="card">
          <h3>Door List</h3>
          <div class="table-wrap"><table><thead><tr><th>Address</th><th>Unit</th><th>Voter</th><th>Result</th><th>Notes</th><th>Knocked</th><th></th></tr></thead><tbody id="walkAddressBody"></tbody></table></div>
        </div>
      </div>
    </div>

    <!-- ==================== VOTER FILE ==================== -->
    <div class="page" id="page-voters">
      <!-- VOTER LIST VIEW -->
      <div id="voters-list-view">
        <div class="card">
          <h3>Voter File</h3>
          <p style="color:#94a3b8;margin-bottom:16px;font-size:14px">Search, import, and manage voter records.</p>
          <div class="form-row-3" style="margin-bottom:16px">
            <div class="form-group"><label>Search</label><input type="text" id="voterSearch" placeholder="Name, address, or phone..." onkeyup="searchVotersDebounced()"></div>
            <div class="form-group"><label>Party</label><select id="voterPartyFilter" onchange="searchVoters()"><option value="">All</option><option value="D">Democrat</option><option value="R">Republican</option><option value="I">Independent</option><option value="NP">No Party</option></select></div>
            <div class="form-group"><label>Support</label><select id="voterSupportFilter" onchange="searchVoters()"><option value="">All</option><option value="strong_support">Strong Support</option><option value="lean_support">Lean Support</option><option value="undecided">Undecided</option><option value="lean_oppose">Lean Oppose</option><option value="strong_oppose">Strong Oppose</option><option value="unknown">Unknown</option></select></div>
          </div>
          <button class="btn btn-primary btn-sm" id="btnAddVoter">Add Voter</button>
          <button class="btn btn-secondary btn-sm" id="btnImportVoters" style="margin-left:8px">Import CSV</button>
        </div>
        <!-- Add voter form -->
        <div class="card" id="addVoterCard" style="display:none">
          <h3>Add Voter</h3>
          <div class="form-row" style="margin-bottom:12px">
            <div class="form-group"><label>First Name</label><input type="text" id="vFirst"></div>
            <div class="form-group"><label>Last Name</label><input type="text" id="vLast"></div>
          </div>
          <div class="form-row" style="margin-bottom:12px">
            <div class="form-group"><label>Phone</label><input type="text" id="vPhone"></div>
            <div class="form-group"><label>Email</label><input type="text" id="vEmail"></div>
          </div>
          <div class="form-row" style="margin-bottom:12px">
            <div class="form-group"><label>Address</label><input type="text" id="vAddress"></div>
            <div class="form-group"><label>City</label><input type="text" id="vCity"></div>
          </div>
          <div class="form-row" style="margin-bottom:12px">
            <div class="form-group"><label>ZIP</label><input type="text" id="vZip"></div>
            <div class="form-group"><label>Party</label><select id="vParty"><option value="">--</option><option value="D">Democrat</option><option value="R">Republican</option><option value="I">Independent</option><option value="NP">No Party</option></select></div>
          </div>
          <div class="form-group" style="margin-bottom:12px"><label>Voter Registration #</label><input type="text" id="vRegNum" placeholder="Voter registration number"></div>
          <button class="btn btn-success btn-sm" onclick="saveNewVoter()">Save Voter</button>
          <button class="btn btn-secondary btn-sm" style="margin-left:8px" onclick="document.getElementById('addVoterCard').style.display='none'">Cancel</button>
        </div>
        <!-- Import voters CSV -->
        <div class="card" id="importVotersCard" style="display:none">
          <h3>Import Voters CSV</h3>
          <p style="color:#94a3b8;margin-bottom:12px;font-size:13px">Headers: first_name, last_name, phone, email, address, city, zip, party, support_level, tags</p>
          <div class="form-group"><textarea id="voterCsvData" rows="8" placeholder="first_name,last_name,phone,address,city,zip,party&#10;John,Doe,+15125551234,123 Main St,Austin,78701,D"></textarea></div>
          <button class="btn btn-success btn-sm" onclick="importVotersCsv()">Import</button>
          <button class="btn btn-secondary btn-sm" style="margin-left:8px" onclick="document.getElementById('importVotersCard').style.display='none'">Cancel</button>
        </div>
        <div class="card">
          <h3>Voters <span class="badge badge-blue" id="voterCount">0</span></h3>
          <div class="table-wrap"><table><thead><tr><th>Name</th><th>Address</th><th>Phone</th><th>Reg #</th><th>Party</th><th>Support</th><th>Actions</th></tr></thead><tbody id="votersBody"></tbody></table></div>
        </div>
      </div>
      <!-- VOTER DETAIL VIEW -->
      <div id="voters-detail-view" style="display:none">
        <div class="back-btn" onclick="showVoterList()">&#8592; Back to Voter File</div>
        <div class="card">
          <h3>Voter Record</h3>
          <div class="form-row" style="margin-bottom:12px">
            <div class="form-group"><label>First Name</label><input type="text" id="vdFirst"></div>
            <div class="form-group"><label>Last Name</label><input type="text" id="vdLast"></div>
          </div>
          <div class="form-row" style="margin-bottom:12px">
            <div class="form-group"><label>Phone</label><input type="text" id="vdPhone"></div>
            <div class="form-group"><label>Email</label><input type="text" id="vdEmail"></div>
          </div>
          <div class="form-row" style="margin-bottom:12px">
            <div class="form-group"><label>Address</label><input type="text" id="vdAddress"></div>
            <div class="form-group"><label>City</label><input type="text" id="vdCity"></div>
          </div>
          <div class="form-row" style="margin-bottom:12px">
            <div class="form-group"><label>ZIP</label><input type="text" id="vdZip"></div>
            <div class="form-group"><label>Party</label><select id="vdParty"><option value="">--</option><option value="D">Democrat</option><option value="R">Republican</option><option value="I">Independent</option><option value="NP">No Party</option></select></div>
          </div>
          <div class="form-row" style="margin-bottom:12px">
            <div class="form-group"><label>Support Level</label><select id="vdSupport"><option value="unknown">Unknown</option><option value="strong_support">Strong Support</option><option value="lean_support">Lean Support</option><option value="undecided">Undecided</option><option value="lean_oppose">Lean Oppose</option><option value="strong_oppose">Strong Oppose</option></select></div>
            <div class="form-group"><label>Tags</label><input type="text" id="vdTags" placeholder="volunteer, donor, ..."></div>
          </div>
          <div class="form-group" style="margin-bottom:12px"><label>Voter Registration #</label><input type="text" id="vdRegNum" placeholder="Voter registration number"></div>
          <div class="form-group"><label>Notes</label><textarea id="vdNotes" rows="3"></textarea></div>
          <button class="btn btn-primary" onclick="saveVoterDetail()">Save Changes</button>
        </div>
        <div class="card">
          <h3>Contact History</h3>
          <div class="form-row" style="margin-bottom:12px">
            <div class="form-group"><label>Type</label><select id="vcType"><option value="door">Door Knock</option><option value="phone">Phone Call</option><option value="text">Text</option><option value="event">Event</option></select></div>
            <div class="form-group"><label>Result</label><input type="text" id="vcResult" placeholder="Supportive, Not Home, etc."></div>
          </div>
          <div class="form-row" style="margin-bottom:12px">
            <div class="form-group"><label>Notes</label><input type="text" id="vcNotes" placeholder="Talked about education policy"></div>
            <div class="form-group"><label>Contacted By</label><input type="text" id="vcBy" placeholder="Volunteer name"></div>
          </div>
          <button class="btn btn-success btn-sm" onclick="logVoterContact()">Log Contact</button>
          <div class="table-wrap" style="margin-top:16px"><table><thead><tr><th>Date</th><th>Type</th><th>Result</th><th>Notes</th><th>By</th></tr></thead><tbody id="voterContactsBody"></tbody></table></div>
        </div>
      </div>
    </div>

    <!-- ==================== EVENTS ==================== -->
    <div class="page" id="page-events">
      <!-- EVENT LIST VIEW -->
      <div id="events-list-view">
        <div class="card">
          <h3>Campaign Events</h3>
          <p style="color:#94a3b8;margin-bottom:16px;font-size:14px">Plan rallies, canvass launches, and fundraisers. Send text invites and track RSVPs.</p>
          <div class="form-row" style="margin-bottom:12px">
            <div class="form-group"><label>Event Title</label><input type="text" id="eventTitle" placeholder="Downtown Rally"></div>
            <div class="form-group"><label>Location</label><input type="text" id="eventLocation" placeholder="City Hall Plaza"></div>
          </div>
          <div class="form-row" style="margin-bottom:12px">
            <div class="form-group"><label>Date</label><input type="date" id="eventDate"></div>
            <div class="form-group"><label>Time</label><input type="time" id="eventTime"></div>
          </div>
          <div class="form-group"><label>Description</label><input type="text" id="eventDesc" placeholder="Join us for a community rally!"></div>
          <button class="btn btn-primary" id="btnCreateEvent">Create Event</button>
        </div>
        <div class="card">
          <h3>Events</h3>
          <div id="eventsList"></div>
        </div>
      </div>
      <!-- EVENT DETAIL VIEW -->
      <div id="events-detail-view" style="display:none">
        <div class="back-btn" onclick="showEventList()">&#8592; Back to Events</div>
        <div class="card">
          <h3 id="eventDetailTitle"></h3>
          <div class="form-row" style="margin-bottom:12px">
            <div><strong style="color:#94a3b8;font-size:13px">Date:</strong> <span id="eventDetailDate"></span></div>
            <div><strong style="color:#94a3b8;font-size:13px">Time:</strong> <span id="eventDetailTime"></span></div>
          </div>
          <div style="margin-bottom:12px"><strong style="color:#94a3b8;font-size:13px">Location:</strong> <span id="eventDetailLocation"></span></div>
          <div style="margin-bottom:12px"><strong style="color:#94a3b8;font-size:13px">Description:</strong> <span id="eventDetailDesc"></span></div>
          <div class="form-group"><label>Status</label><select class="inline-select" id="eventDetailStatus" onchange="updateEventStatus()"><option value="upcoming">Upcoming</option><option value="in_progress">In Progress</option><option value="completed">Completed</option><option value="cancelled">Cancelled</option></select></div>
          <div style="margin-top:16px">
            <button class="btn btn-primary btn-sm" onclick="showQrCode()">&#128274; Show QR Check-In Code</button>
            <span style="font-size:12px;color:#64748b;margin-left:8px" id="checkinCount"></span>
          </div>
        </div>
        <div class="card">
          <h3>Send Text Invites</h3>
          <p style="color:#94a3b8;margin-bottom:12px;font-size:13px">Select contacts to invite via SMS.</p>
          <div class="check-list" id="inviteContactList"></div>
          <div style="margin-top:12px">
            <button class="btn btn-sm btn-secondary" onclick="toggleAllInvites(true)">Select All</button>
            <button class="btn btn-sm btn-secondary" style="margin-left:4px" onclick="toggleAllInvites(false)">Deselect All</button>
            <button class="btn btn-sm btn-success" style="margin-left:8px" onclick="sendEventInvites()">Send Invites</button>
          </div>
          <div id="inviteAlert" style="margin-top:12px"></div>
        </div>
        <div class="card">
          <h3>RSVPs <span class="badge badge-blue" id="rsvpCount">0</span></h3>
          <div class="stats-grid" style="margin-bottom:16px" id="rsvpStats"></div>
          <div class="table-wrap"><table><thead><tr><th>Name</th><th>Phone</th><th>Status</th><th>Invited</th></tr></thead><tbody id="rsvpBody"></tbody></table></div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
// ===================== STATE =====================
let state = {
  credentials: JSON.parse(localStorage.getItem('twilioCredentials') || '{}'),
  contacts: [],
  connected: false,
  currentWalkId: null,
  currentVoterId: null,
  currentEventId: null
};
let searchTimeout = null;

// ===================== HELPERS =====================
function escHtml(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }
async function api(path, opts) {
  const res = await fetch(path, opts);
  return res.json();
}
async function apiPost(path, body) {
  return api(path, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
}
async function apiPut(path, body) {
  return api(path, { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
}
async function apiDelete(path) {
  return api(path, { method: 'DELETE' });
}
async function apiPatch(path, body) {
  return api(path, { method: 'PATCH', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
}
function partyBadge(p) {
  const colors = { D: 'badge-blue', R: 'badge-red', I: 'badge-purple', NP: 'badge-gray' };
  const names = { D: 'Dem', R: 'Rep', I: 'Ind', NP: 'NP' };
  return p ? '<span class="badge ' + (colors[p]||'badge-gray') + '">' + (names[p]||p) + '</span>' : '';
}
function supportBadge(s) {
  const colors = { strong_support:'badge-green', lean_support:'badge-green', undecided:'badge-yellow', lean_oppose:'badge-red', strong_oppose:'badge-red', unknown:'badge-gray' };
  const names = { strong_support:'Strong Sup', lean_support:'Lean Sup', undecided:'Undecided', lean_oppose:'Lean Opp', strong_oppose:'Strong Opp', unknown:'Unknown' };
  return '<span class="badge ' + (colors[s]||'badge-gray') + '">' + (names[s]||s||'Unknown') + '</span>';
}
function resultBadge(r) {
  const colors = { not_visited:'badge-gray', not_home:'badge-yellow', supportive:'badge-green', undecided:'badge-yellow', opposed:'badge-red', moved:'badge-gray', refused:'badge-red', come_back:'badge-blue' };
  return '<span class="badge ' + (colors[r]||'badge-gray') + '">' + (r||'').replace(/_/g,' ') + '</span>';
}
function statusBadge(s) {
  const colors = { pending:'badge-yellow', in_progress:'badge-blue', completed:'badge-green', upcoming:'badge-blue', cancelled:'badge-red' };
  return '<span class="badge ' + (colors[s]||'badge-gray') + '">' + (s||'').replace(/_/g,' ') + '</span>';
}

// ===================== NAV =====================
document.querySelectorAll('.nav-item').forEach(item => {
  item.addEventListener('click', () => {
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    item.classList.add('active');
    const page = item.dataset.page;
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById('page-' + page).classList.add('active');
    document.getElementById('pageTitle').textContent = item.querySelector('span:last-child').textContent;
    // Load data when switching pages
    if (page === 'contacts') loadContacts();
    if (page === 'walks') { showWalkList(); loadWalks(); }
    if (page === 'voters') { showVoterList(); searchVoters(); }
    if (page === 'events') { showEventList(); loadEvents(); }
    if (page === 'inbox') loadInbox();
    if (page === 'dashboard') loadDashboard();
    if (page === 'knowledge') loadKnowledge();
    if (page === 'p2p') { showP2pAdmin(); loadP2pContacts(); }
  });
});

// ===================== TWILIO SETUP =====================
function loadCredentials() {
  const c = state.credentials;
  if (c.accountSid) document.getElementById('accountSid').value = c.accountSid;
  if (c.authToken) document.getElementById('authToken').value = c.authToken;
  if (c.fromNumber) document.getElementById('fromNumber').value = c.fromNumber;
  if (c.connected) setConnected(true, c.accountName);
}
function setConnected(yes, name) {
  state.connected = yes;
  document.getElementById('connDot').className = yes ? 'conn-dot on' : 'conn-dot off';
  document.getElementById('connLabel').textContent = yes ? (name || 'Connected') : 'Not Connected';
}
document.getElementById('btnTestConnection').addEventListener('click', async () => {
  const sid = document.getElementById('accountSid').value.trim();
  const token = document.getElementById('authToken').value.trim();
  const el = document.getElementById('twilioAlert');
  if (!sid || !token) { el.innerHTML = '<div class="alert alert-error">Please enter Account SID and Auth Token.</div>'; return; }
  el.innerHTML = '<div class="alert alert-info">Testing connection...</div>';
  try {
    const data = await apiPost('/test-connection', { accountSid: sid, authToken: token });
    if (data.success) {
      el.innerHTML = '<div class="alert alert-success">Connected to: ' + data.accountName + '</div>';
      setConnected(true, data.accountName);
      state.credentials.accountSid = sid; state.credentials.authToken = token;
      state.credentials.connected = true; state.credentials.accountName = data.accountName;
    } else {
      el.innerHTML = '<div class="alert alert-error">' + data.error + '</div>'; setConnected(false);
    }
  } catch (err) { el.innerHTML = '<div class="alert alert-error">Failed: ' + err.message + '</div>'; setConnected(false); }
});
document.getElementById('btnSaveCredentials').addEventListener('click', () => {
  state.credentials.accountSid = document.getElementById('accountSid').value.trim();
  state.credentials.authToken = document.getElementById('authToken').value.trim();
  state.credentials.fromNumber = document.getElementById('fromNumber').value.trim();
  localStorage.setItem('twilioCredentials', JSON.stringify(state.credentials));
  document.getElementById('twilioAlert').innerHTML = '<div class="alert alert-success">Credentials saved.</div>';
});

// ===================== CONTACTS (server-side) =====================
async function loadContacts() {
  const data = await api('/api/contacts');
  state.contacts = data.contacts || [];
  renderContacts();
}
function renderContacts() {
  const tbody = document.getElementById('contactsBody');
  document.getElementById('contactCount').textContent = state.contacts.length;
  document.getElementById('sendToCount').textContent = state.contacts.length;
  if (state.contacts.length === 0) { tbody.innerHTML = '<tr><td colspan="5" style="color:#64748b;text-align:center">No contacts.</td></tr>'; return; }
  tbody.innerHTML = state.contacts.map(c =>
    '<tr><td>' + escHtml(c.phone) + '</td><td>' + escHtml(c.first_name) + '</td><td>' + escHtml(c.last_name) + '</td><td>' + escHtml(c.city) + '</td><td><button class="btn btn-danger btn-xs" onclick="removeContact(' + c.id + ')">Remove</button></td></tr>'
  ).join('');
}
window.removeContact = async function(id) {
  await apiDelete('/api/contacts/' + id);
  loadContacts();
};
document.getElementById('btnAddContact').addEventListener('click', async () => {
  const phone = document.getElementById('cPhone').value.trim();
  if (!phone) return;
  await apiPost('/api/contacts', { phone, firstName: document.getElementById('cFirst').value.trim(), lastName: document.getElementById('cLast').value.trim(), city: document.getElementById('cCity').value.trim() });
  document.getElementById('cPhone').value = ''; document.getElementById('cFirst').value = '';
  document.getElementById('cLast').value = ''; document.getElementById('cCity').value = '';
  loadContacts();
});
document.getElementById('btnImportCSV').addEventListener('click', () => { document.getElementById('csvImportCard').style.display = 'block'; });
document.getElementById('btnCancelCSV').addEventListener('click', () => { document.getElementById('csvImportCard').style.display = 'none'; });
document.getElementById('btnParseCSV').addEventListener('click', async () => {
  const raw = document.getElementById('csvData').value.trim();
  if (!raw) return;
  const lines = raw.split('\n').map(l => l.trim()).filter(Boolean);
  const header = lines[0].toLowerCase().split(',').map(h => h.trim());
  const pi = header.indexOf('phone'); if (pi === -1) { alert('CSV must have a "phone" column.'); return; }
  const fi = header.indexOf('firstname'), li = header.indexOf('lastname'), ci = header.indexOf('city');
  const contacts = [];
  for (let i = 1; i < lines.length; i++) {
    const cols = lines[i].split(',').map(c => c.trim());
    if (cols[pi]) contacts.push({ phone: cols[pi], firstName: fi >= 0 ? cols[fi] : '', lastName: li >= 0 ? cols[li] : '', city: ci >= 0 ? cols[ci] : '' });
  }
  if (contacts.length) { await apiPost('/api/contacts/import', { contacts }); loadContacts(); }
  document.getElementById('csvImportCard').style.display = 'none'; document.getElementById('csvData').value = '';
});
document.getElementById('btnClearContacts').addEventListener('click', async () => {
  if (confirm('Remove all contacts?')) { await apiDelete('/api/contacts'); loadContacts(); }
});

// ===================== COMPOSE & SEND =====================
document.getElementById('btnSendCampaign').addEventListener('click', async () => {
  const el = document.getElementById('composeAlert');
  const c = state.credentials;
  if (!c.accountSid || !c.authToken || !c.fromNumber) { el.innerHTML = '<div class="alert alert-error">Set up Twilio credentials first.</div>'; return; }
  if (state.contacts.length === 0) { el.innerHTML = '<div class="alert alert-error">No contacts loaded.</div>'; return; }
  const msg = document.getElementById('messageTemplate').value.trim();
  if (!msg) { el.innerHTML = '<div class="alert alert-error">Write a message first.</div>'; return; }
  if (!confirm('Send to ' + state.contacts.length + ' contacts?')) return;
  el.innerHTML = '<div class="alert alert-info">Sending...</div>';
  document.getElementById('btnSendCampaign').disabled = true;
  try {
    const data = await apiPost('/send', { accountSid: c.accountSid, authToken: c.authToken, from: c.fromNumber, contacts: state.contacts, messageTemplate: msg, optOutFooter: document.getElementById('optOutFooter').value.trim() });
    if (data.success) {
      el.innerHTML = '<div class="alert alert-success">Sent! ' + data.sent + ' delivered, ' + data.failed + ' failed.</div>';
      const rc = document.getElementById('sendResultCard'); rc.style.display = 'block';
      let html = '<p><strong>Sent:</strong> ' + data.sent + ' / ' + data.totalContacts + '</p>';
      if (data.errors && data.errors.length > 0) { html += '<ul style="margin-left:16px;color:#fca5a5">'; data.errors.forEach(e => html += '<li>' + e.phone + ': ' + e.reason + '</li>'); html += '</ul>'; }
      document.getElementById('sendResults').innerHTML = html;
    } else { el.innerHTML = '<div class="alert alert-error">' + (data.error || 'Failed.') + '</div>'; }
  } catch (err) { el.innerHTML = '<div class="alert alert-error">' + err.message + '</div>'; }
  document.getElementById('btnSendCampaign').disabled = false;
});

// ===================== INBOX =====================
async function loadInbox() {
  try {
    const data = await api('/api/messages');
    const el = document.getElementById('inboxMessages');
    if (!data.messages || data.messages.length === 0) { el.innerHTML = '<div style="color:#64748b;font-size:14px">No messages yet.</div>'; }
    else {
      el.innerHTML = data.messages.map(m => {
        const sBadge = m.sentiment === 'positive' ? '<span class="badge badge-green" style="margin-left:8px">Positive</span>'
          : m.sentiment === 'negative' ? '<span class="badge badge-red" style="margin-left:8px">Negative</span>'
          : m.sentiment ? '<span class="badge badge-gray" style="margin-left:8px">Neutral</span>' : '';
        return '<div class="msg-item"><div class="phone">' + escHtml(m.phone) + sBadge + '</div><div class="body">' + escHtml(m.body) + '</div><div class="time">' + new Date(m.timestamp).toLocaleString() + '</div>' +
        '<div class="reply-box"><input type="text" placeholder="Type reply..." id="reply-' + (m.phone||'').replace(/\+/g,'') + '"><button class="btn btn-primary btn-sm" onclick="sendReply(\'' + m.phone + '\')">Reply</button></div></div>';
      }).join('');
    }
    const optEl = document.getElementById('optedOutList');
    if (!data.optedOut || data.optedOut.length === 0) { optEl.textContent = 'No opted-out numbers.'; }
    else { optEl.innerHTML = data.optedOut.map(n => '<span class="badge badge-red" style="margin:2px">' + escHtml(n) + '</span>').join(' '); }
  } catch (err) { console.error('Inbox load failed:', err); }
}
window.sendReply = async function(phone) {
  const c = state.credentials;
  if (!c.accountSid || !c.authToken || !c.fromNumber) { alert('Set up Twilio first.'); return; }
  const input = document.getElementById('reply-' + phone.replace(/\+/g,''));
  const body = input.value.trim(); if (!body) return;
  try { await apiPost('/reply', { accountSid: c.accountSid, authToken: c.authToken, from: c.fromNumber, to: phone, body }); input.value = ''; } catch (err) { alert('Reply failed.'); }
};
document.getElementById('btnRefreshInbox').addEventListener('click', loadInbox);

// ===================== DASHBOARD =====================
async function loadDashboard() {
  try {
    const data = await api('/api/stats');
    document.getElementById('statSent').textContent = data.sent || 0;
    document.getElementById('statResponses').textContent = data.responses || 0;
    document.getElementById('statContacts').textContent = data.contacts || 0;
    document.getElementById('statDoors').textContent = data.doorsKnocked || 0;
    document.getElementById('statWalks').textContent = (data.walks || 0) + ' block walks';
    document.getElementById('statVoters').textContent = data.voters || 0;
    document.getElementById('statEvents').textContent = data.upcomingEvents || 0;
    const rRate = data.sent > 0 ? Math.round(data.responses / data.sent * 100) : 0;
    document.getElementById('statResponseRate').textContent = rRate + '% response rate';
  } catch (err) {}
  try {
    const data = await api('/api/activity');
    const el = document.getElementById('activityLog');
    if (!data.logs || data.logs.length === 0) { el.innerHTML = '<div class="log-entry" style="color:#64748b">No activity yet.</div>'; }
    else { el.innerHTML = data.logs.map(l => '<div class="log-entry"><span class="log-time">' + new Date(l.created_at).toLocaleString() + '</span> &mdash; ' + escHtml(l.message) + '</div>').join(''); }
  } catch (err) {}
  document.getElementById('lastUpdated').textContent = 'Last updated: ' + new Date().toLocaleString();
  loadSentimentStats();
}

// ===================== BLOCK WALK =====================
function showWalkList() { document.getElementById('walks-list-view').style.display = 'block'; document.getElementById('walks-detail-view').style.display = 'none'; }
function showWalkDetail(id) { state.currentWalkId = id; document.getElementById('walks-list-view').style.display = 'none'; document.getElementById('walks-detail-view').style.display = 'block'; loadWalkDetail(id); }
window.showWalkList = showWalkList;
window.showWalkDetail = showWalkDetail;

async function loadWalks() {
  const data = await api('/api/walks');
  const tbody = document.getElementById('walksBody');
  if (!data.walks || data.walks.length === 0) { tbody.innerHTML = '<tr><td colspan="5" style="color:#64748b;text-align:center">No walks created yet.</td></tr>'; return; }
  tbody.innerHTML = data.walks.map(w => {
    const pct = w.totalAddresses > 0 ? Math.round(w.knocked / w.totalAddresses * 100) : 0;
    return '<tr><td><a href="#" onclick="showWalkDetail(' + w.id + ');return false">' + escHtml(w.name) + '</a></td><td>' + escHtml(w.assigned_to) + '</td><td>' + statusBadge(w.status) + '</td><td><div class="progress-bar" style="width:120px"><div class="progress-fill green" style="width:' + pct + '%"></div></div><span style="font-size:11px;color:#64748b">' + w.knocked + '/' + w.totalAddresses + '</span></td><td><button class="btn btn-danger btn-xs" onclick="deleteWalk(' + w.id + ')">Delete</button></td></tr>';
  }).join('');
}

async function loadWalkDetail(id) {
  const data = await api('/api/walks/' + id);
  const w = data.walk;
  document.getElementById('walkDetailName').textContent = w.name;
  document.getElementById('walkDetailAssign').textContent = w.assigned_to || 'Unassigned';
  document.getElementById('walkDetailStatus').value = w.status;
  // Result stats
  const results = ['not_visited','not_home','supportive','undecided','opposed','moved','refused','come_back'];
  const statsHtml = results.map(r => '<div class="stat-card" style="padding:12px"><div class="label">' + r.replace(/_/g,' ') + '</div><div class="value" style="font-size:20px">' + (w.resultStats[r] || 0) + '</div></div>').join('');
  document.getElementById('walkResultStats').innerHTML = statsHtml;
  // Progress
  const total = w.addresses.length;
  const knocked = w.addresses.filter(a => a.result !== 'not_visited').length;
  const pct = total > 0 ? Math.round(knocked / total * 100) : 0;
  document.getElementById('walkProgress').style.width = pct + '%';
  document.getElementById('walkProgressLabel').textContent = knocked + ' / ' + total + ' doors knocked (' + pct + '%)';
  // Address table
  const tbody = document.getElementById('walkAddressBody');
  if (w.addresses.length === 0) { tbody.innerHTML = '<tr><td colspan="7" style="color:#64748b;text-align:center">No addresses added yet.</td></tr>'; return; }
  tbody.innerHTML = w.addresses.map(a =>
    '<tr><td>' + escHtml(a.address) + '</td><td>' + escHtml(a.unit) + '</td><td>' + escHtml(a.voter_name) + '</td>' +
    '<td><select class="inline-select" onchange="updateDoorResult(' + a.id + ',this.value)" data-addr="' + a.id + '">' +
    ['not_visited','not_home','supportive','undecided','opposed','moved','refused','come_back'].map(r => '<option value="' + r + '"' + (a.result === r ? ' selected' : '') + '>' + r.replace(/_/g,' ') + '</option>').join('') +
    '</select></td><td><input type="text" class="inline-select" style="width:120px" value="' + escHtml(a.notes) + '" onchange="updateDoorNotes(' + a.id + ',this.value)"></td>' +
    '<td style="font-size:11px;color:#64748b">' + (a.knocked_at ? new Date(a.knocked_at).toLocaleString() : '-') + '</td>' +
    '<td><button class="btn btn-danger btn-xs" onclick="deleteWalkAddr(' + a.id + ')">X</button></td></tr>'
  ).join('');
}

window.updateDoorResult = async function(addrId, result) {
  await apiPut('/api/walks/' + state.currentWalkId + '/addresses/' + addrId, { result });
  loadWalkDetail(state.currentWalkId);
};
window.updateDoorNotes = async function(addrId, notes) {
  await apiPut('/api/walks/' + state.currentWalkId + '/addresses/' + addrId, { notes });
};
window.updateWalkStatus = async function() {
  await apiPut('/api/walks/' + state.currentWalkId, { status: document.getElementById('walkDetailStatus').value });
};
window.deleteWalkAddr = async function(addrId) {
  await apiDelete('/api/walks/' + state.currentWalkId + '/addresses/' + addrId);
  loadWalkDetail(state.currentWalkId);
};
window.deleteWalk = async function(id) {
  if (confirm('Delete this walk and all its addresses?')) { await apiDelete('/api/walks/' + id); loadWalks(); }
};

document.getElementById('btnCreateWalk').addEventListener('click', async () => {
  const name = document.getElementById('walkName').value.trim();
  if (!name) return;
  await apiPost('/api/walks', { name, description: document.getElementById('walkDesc').value.trim(), assigned_to: document.getElementById('walkAssign').value.trim() });
  document.getElementById('walkName').value = ''; document.getElementById('walkDesc').value = ''; document.getElementById('walkAssign').value = '';
  loadWalks();
});

document.getElementById('btnAddWalkAddresses').addEventListener('click', async () => {
  const raw = document.getElementById('walkAddressInput').value.trim();
  if (!raw) return;
  const addresses = raw.split('\n').map(l => l.trim()).filter(Boolean).map(l => {
    const parts = l.split(',').map(p => p.trim());
    return { address: parts[0] || '', unit: parts[1] || '', city: parts[2] || '', zip: parts[3] || '', voter_name: parts[4] || '' };
  });
  await apiPost('/api/walks/' + state.currentWalkId + '/addresses', { addresses });
  document.getElementById('walkAddressInput').value = '';
  loadWalkDetail(state.currentWalkId);
});

// ===================== VOTER FILE =====================
function showVoterList() { document.getElementById('voters-list-view').style.display = 'block'; document.getElementById('voters-detail-view').style.display = 'none'; }
function showVoterDetail(id) { state.currentVoterId = id; document.getElementById('voters-list-view').style.display = 'none'; document.getElementById('voters-detail-view').style.display = 'block'; loadVoterDetail(id); }
window.showVoterList = showVoterList;
window.showVoterDetail = showVoterDetail;

function searchVotersDebounced() { clearTimeout(searchTimeout); searchTimeout = setTimeout(searchVoters, 300); }
window.searchVotersDebounced = searchVotersDebounced;

async function searchVoters() {
  const q = (document.getElementById('voterSearch') || {}).value || '';
  const party = (document.getElementById('voterPartyFilter') || {}).value || '';
  const support = (document.getElementById('voterSupportFilter') || {}).value || '';
  let url = '/api/voters?';
  if (q) url += 'q=' + encodeURIComponent(q) + '&';
  if (party) url += 'party=' + party + '&';
  if (support) url += 'support=' + support + '&';
  const data = await api(url);
  const voters = data.voters || [];
  document.getElementById('voterCount').textContent = voters.length;
  const tbody = document.getElementById('votersBody');
  if (voters.length === 0) { tbody.innerHTML = '<tr><td colspan="7" style="color:#64748b;text-align:center">No voters found.</td></tr>'; return; }
  tbody.innerHTML = voters.map(v =>
    '<tr><td><a href="#" onclick="showVoterDetail(' + v.id + ');return false">' + escHtml(v.first_name + ' ' + v.last_name) + '</a></td><td>' + escHtml(v.address) + '</td><td>' + escHtml(v.phone) + '</td><td style="font-size:12px">' + escHtml(v.registration_number || '') + '</td><td>' + partyBadge(v.party) + '</td><td>' + supportBadge(v.support_level) + '</td><td><button class="btn btn-danger btn-xs" onclick="deleteVoter(' + v.id + ')">Del</button></td></tr>'
  ).join('');
}
window.searchVoters = searchVoters;

async function loadVoterDetail(id) {
  const data = await api('/api/voters/' + id);
  const v = data.voter;
  document.getElementById('vdFirst').value = v.first_name || '';
  document.getElementById('vdLast').value = v.last_name || '';
  document.getElementById('vdPhone').value = v.phone || '';
  document.getElementById('vdEmail').value = v.email || '';
  document.getElementById('vdAddress').value = v.address || '';
  document.getElementById('vdCity').value = v.city || '';
  document.getElementById('vdZip').value = v.zip || '';
  document.getElementById('vdParty').value = v.party || '';
  document.getElementById('vdSupport').value = v.support_level || 'unknown';
  document.getElementById('vdTags').value = v.tags || '';
  document.getElementById('vdRegNum').value = v.registration_number || '';
  document.getElementById('vdNotes').value = v.notes || '';
  // Contact history
  const tbody = document.getElementById('voterContactsBody');
  if (!v.contactHistory || v.contactHistory.length === 0) { tbody.innerHTML = '<tr><td colspan="5" style="color:#64748b">No contact history.</td></tr>'; }
  else {
    tbody.innerHTML = v.contactHistory.map(c =>
      '<tr><td style="font-size:12px">' + new Date(c.contacted_at).toLocaleString() + '</td><td>' + resultBadge(c.contact_type) + '</td><td>' + escHtml(c.result) + '</td><td>' + escHtml(c.notes) + '</td><td>' + escHtml(c.contacted_by) + '</td></tr>'
    ).join('');
  }
}

window.saveVoterDetail = async function() {
  await apiPut('/api/voters/' + state.currentVoterId, {
    first_name: document.getElementById('vdFirst').value, last_name: document.getElementById('vdLast').value,
    phone: document.getElementById('vdPhone').value, email: document.getElementById('vdEmail').value,
    address: document.getElementById('vdAddress').value, city: document.getElementById('vdCity').value,
    zip: document.getElementById('vdZip').value, party: document.getElementById('vdParty').value,
    support_level: document.getElementById('vdSupport').value, tags: document.getElementById('vdTags').value,
    registration_number: document.getElementById('vdRegNum').value, notes: document.getElementById('vdNotes').value
  });
  alert('Voter saved.');
};

window.logVoterContact = async function() {
  await apiPost('/api/voters/' + state.currentVoterId + '/contacts', {
    contact_type: document.getElementById('vcType').value, result: document.getElementById('vcResult').value,
    notes: document.getElementById('vcNotes').value, contacted_by: document.getElementById('vcBy').value
  });
  document.getElementById('vcResult').value = ''; document.getElementById('vcNotes').value = '';
  loadVoterDetail(state.currentVoterId);
};

window.deleteVoter = async function(id) {
  if (confirm('Delete this voter?')) { await apiDelete('/api/voters/' + id); searchVoters(); }
};

window.saveNewVoter = async function() {
  await apiPost('/api/voters', {
    first_name: document.getElementById('vFirst').value, last_name: document.getElementById('vLast').value,
    phone: document.getElementById('vPhone').value, email: document.getElementById('vEmail').value,
    address: document.getElementById('vAddress').value, city: document.getElementById('vCity').value,
    zip: document.getElementById('vZip').value, party: document.getElementById('vParty').value,
    registration_number: document.getElementById('vRegNum').value
  });
  document.getElementById('addVoterCard').style.display = 'none';
  ['vFirst','vLast','vPhone','vEmail','vAddress','vCity','vZip','vRegNum'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('vParty').value = '';
  searchVoters();
};

window.importVotersCsv = async function() {
  const raw = document.getElementById('voterCsvData').value.trim();
  if (!raw) return;
  const lines = raw.split('\n').map(l => l.trim()).filter(Boolean);
  const header = lines[0].toLowerCase().split(',').map(h => h.trim());
  const voters = [];
  for (let i = 1; i < lines.length; i++) {
    const cols = lines[i].split(',').map(c => c.trim());
    const v = {};
    header.forEach((h, idx) => { v[h] = cols[idx] || ''; });
    voters.push(v);
  }
  if (voters.length) { await apiPost('/api/voters/import', { voters }); searchVoters(); }
  document.getElementById('importVotersCard').style.display = 'none'; document.getElementById('voterCsvData').value = '';
};

document.getElementById('btnAddVoter').addEventListener('click', () => { document.getElementById('addVoterCard').style.display = 'block'; });
document.getElementById('btnImportVoters').addEventListener('click', () => { document.getElementById('importVotersCard').style.display = 'block'; });

// ===================== EVENTS =====================
function showEventList() { document.getElementById('events-list-view').style.display = 'block'; document.getElementById('events-detail-view').style.display = 'none'; }
function showEventDetail(id) { state.currentEventId = id; document.getElementById('events-list-view').style.display = 'none'; document.getElementById('events-detail-view').style.display = 'block'; loadEventDetail(id); }
window.showEventList = showEventList;
window.showEventDetail = showEventDetail;

async function loadEvents() {
  const data = await api('/api/events');
  const el = document.getElementById('eventsList');
  if (!data.events || data.events.length === 0) { el.innerHTML = '<div style="color:#64748b;font-size:14px">No events yet.</div>'; return; }
  el.innerHTML = data.events.map(e => {
    const s = e.rsvpStats || {};
    return '<div class="event-card"><div class="event-info"><h4><a href="#" onclick="showEventDetail(' + e.id + ');return false">' + escHtml(e.title) + '</a></h4><div class="event-meta">' + e.event_date + (e.event_time ? ' at ' + e.event_time : '') + ' &mdash; ' + escHtml(e.location || 'TBD') + '</div><div style="margin-top:6px">' + statusBadge(e.status) + ' <span style="font-size:12px;color:#64748b;margin-left:8px">' + (s.total || 0) + ' invited, ' + (s.confirmed || 0) + ' confirmed</span></div></div><div><button class="btn btn-danger btn-xs" onclick="deleteEvent(' + e.id + ')">Delete</button></div></div>';
  }).join('');
}

async function loadEventDetail(id) {
  const data = await api('/api/events/' + id);
  const e = data.event;
  document.getElementById('eventDetailTitle').textContent = e.title;
  document.getElementById('eventDetailDate').textContent = e.event_date;
  document.getElementById('eventDetailTime').textContent = e.event_time || 'TBD';
  document.getElementById('eventDetailLocation').textContent = e.location || 'TBD';
  document.getElementById('eventDetailDesc').textContent = e.description || '';
  document.getElementById('eventDetailStatus').value = e.status;
  // RSVP stats
  const rsvps = e.rsvps || [];
  const counts = { invited: 0, confirmed: 0, declined: 0, attended: 0, no_show: 0 };
  rsvps.forEach(r => { counts[r.rsvp_status] = (counts[r.rsvp_status] || 0) + 1; });
  document.getElementById('rsvpCount').textContent = rsvps.length;
  const checkedIn = rsvps.filter(r => r.checked_in_at).length;
  document.getElementById('checkinCount').textContent = checkedIn > 0 ? checkedIn + ' checked in' : '';
  document.getElementById('rsvpStats').innerHTML = Object.keys(counts).map(k =>
    '<div class="stat-card" style="padding:12px"><div class="label">' + k.replace(/_/g,' ') + '</div><div class="value" style="font-size:20px">' + counts[k] + '</div></div>'
  ).join('');
  // RSVP table
  const tbody = document.getElementById('rsvpBody');
  if (rsvps.length === 0) { tbody.innerHTML = '<tr><td colspan="4" style="color:#64748b">No RSVPs yet. Send invites below.</td></tr>'; }
  else {
    tbody.innerHTML = rsvps.map(r =>
      '<tr><td>' + escHtml(r.contact_name) + '</td><td>' + escHtml(r.contact_phone) + '</td><td><select class="inline-select" onchange="updateRsvp(' + r.id + ',this.value)">' +
      ['invited','confirmed','declined','attended','no_show'].map(s => '<option value="' + s + '"' + (r.rsvp_status === s ? ' selected' : '') + '>' + s.replace(/_/g,' ') + '</option>').join('') +
      '</select></td><td style="font-size:11px;color:#64748b">' + new Date(r.invited_at).toLocaleString() + '</td></tr>'
    ).join('');
  }
  // Contact list for invites
  await loadContacts();
  const cl = document.getElementById('inviteContactList');
  if (state.contacts.length === 0) { cl.innerHTML = '<div style="color:#64748b;font-size:13px">No contacts. Add contacts first.</div>'; }
  else {
    cl.innerHTML = state.contacts.map(c =>
      '<div class="check-item"><input type="checkbox" value="' + c.id + '" class="invite-check"><span>' + escHtml(c.first_name + ' ' + c.last_name) + ' (' + escHtml(c.phone) + ')</span></div>'
    ).join('');
  }
}

window.updateRsvp = async function(rsvpId, status) {
  await apiPut('/api/events/' + state.currentEventId + '/rsvps/' + rsvpId, { rsvp_status: status });
};
window.updateEventStatus = async function() {
  await apiPut('/api/events/' + state.currentEventId, { status: document.getElementById('eventDetailStatus').value });
};
window.deleteEvent = async function(id) {
  if (confirm('Delete this event?')) { await apiDelete('/api/events/' + id); loadEvents(); }
};
window.toggleAllInvites = function(check) {
  document.querySelectorAll('.invite-check').forEach(cb => cb.checked = check);
};
window.sendEventInvites = async function() {
  const c = state.credentials;
  if (!c.accountSid || !c.authToken || !c.fromNumber) { alert('Set up Twilio first.'); return; }
  const selected = [...document.querySelectorAll('.invite-check:checked')].map(cb => parseInt(cb.value));
  if (selected.length === 0) { alert('Select contacts to invite.'); return; }
  const el = document.getElementById('inviteAlert');
  el.innerHTML = '<div class="alert alert-info">Sending invites...</div>';
  const data = await apiPost('/api/events/' + state.currentEventId + '/invite', { accountSid: c.accountSid, authToken: c.authToken, from: c.fromNumber, contactIds: selected });
  el.innerHTML = '<div class="alert alert-success">Sent ' + data.sent + ' invites!</div>';
  loadEventDetail(state.currentEventId);
};

document.getElementById('btnCreateEvent').addEventListener('click', async () => {
  const title = document.getElementById('eventTitle').value.trim();
  const date = document.getElementById('eventDate').value;
  if (!title || !date) { alert('Title and date are required.'); return; }
  await apiPost('/api/events', { title, location: document.getElementById('eventLocation').value.trim(), event_date: date, event_time: document.getElementById('eventTime').value, description: document.getElementById('eventDesc').value.trim() });
  document.getElementById('eventTitle').value = ''; document.getElementById('eventLocation').value = '';
  document.getElementById('eventDate').value = ''; document.getElementById('eventTime').value = '';
  document.getElementById('eventDesc').value = '';
  loadEvents();
});

// ===================== MIGRATE localStorage contacts (one-time) =====================
async function migrateLocalStorage() {
  const old = JSON.parse(localStorage.getItem('contacts') || '[]');
  if (old.length > 0) {
    await apiPost('/api/contacts/import', { contacts: old });
    localStorage.removeItem('contacts');
    localStorage.removeItem('activityLog');
  }
}

// ===================== QR CODE =====================
window.showQrCode = function() {
  const url = window.location.origin + '/checkin/' + state.currentEventId;
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };
  overlay.innerHTML = '<div class="modal-box" style="position:relative"><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()">&times;</button><h3>Event QR Check-In</h3><p style="color:#94a3b8;font-size:13px;margin-bottom:16px">Attendees scan this QR code to check in</p><canvas id="qrCanvas"></canvas><p style="font-size:12px;color:#64748b;margin:12px 0;word-break:break-all">' + escHtml(url) + '</p><div style="display:flex;gap:8px;justify-content:center"><button class="btn btn-secondary btn-sm" onclick="navigator.clipboard.writeText(\'' + url + '\');this.textContent=\'Copied!\'">Copy Link</button><button class="btn btn-primary btn-sm" onclick="printQr()">Print QR</button></div></div>';
  document.body.appendChild(overlay);
  if (typeof QRCode !== 'undefined') {
    QRCode.toCanvas(document.getElementById('qrCanvas'), url, { width: 256, margin: 2, color: { dark: '#000000', light: '#ffffff' } });
  }
};

window.printQr = function() {
  const canvas = document.getElementById('qrCanvas');
  if (!canvas) return;
  const win = window.open('', '_blank');
  const img = canvas.toDataURL();
  const link = window.location.origin + '/checkin/' + state.currentEventId;
  win.document.open();
  win.document.writeln('<html><head><title>QR Check-In</title></head><body style="font-family:sans-serif;text-align:center;padding:40px"><h1>Scan to Check In</h1><img src="' + img + '" width="300" height="300"><p>' + escHtml(link) + '</p></body></html>');
  win.document.close();
  win.onload = function() { win.print(); };
};

// ===================== SENTIMENT DASHBOARD =====================
async function loadSentimentStats() {
  try {
    const data = await api('/api/stats/sentiment');
    const total = (data.positive || 0) + (data.negative || 0) + (data.neutral || 0);
    if (total === 0) { document.getElementById('statSentiment').textContent = 'No data'; return; }
    document.getElementById('statSentiment').innerHTML =
      '<span style="color:#4ade80">' + data.positive + '</span> / ' +
      '<span style="color:#fca5a5">' + data.negative + '</span> / ' +
      '<span style="color:#94a3b8">' + data.neutral + '</span>';
  } catch (e) {}
}

// ===================== KNOWLEDGE BASE =====================
async function loadKnowledge() {
  // Load API key
  try {
    const d = await api('/api/settings/anthropic_api_key');
    if (d.value) document.getElementById('anthropicKey').value = d.value;
  } catch(e) {}
  // Load knowledge entries
  try {
    const d = await api('/api/knowledge');
    const entries = d.entries || [];
    // Bio
    const bio = entries.find(e => e.type === 'bio');
    if (bio) document.getElementById('kdBio').value = bio.content;
    // Campaign details
    const details = entries.filter(e => e.type === 'details');
    for (const det of details) {
      if (det.title === 'Campaign Name') document.getElementById('kdCampaignName').value = det.content;
      if (det.title === 'Election Date') document.getElementById('kdElectionDate').value = det.content;
      if (det.title === 'Website') document.getElementById('kdWebsite').value = det.content;
      if (det.title === 'Key Message') document.getElementById('kdSlogan').value = det.content;
    }
    // Policies
    const policies = entries.filter(e => e.type === 'policy');
    renderPolicies(policies);
  } catch(e) {}
  // Load scripts
  try {
    const d = await api('/api/scripts');
    renderScripts(d.scripts || []);
  } catch(e) {}
}

function renderPolicies(policies) {
  const el = document.getElementById('policiesList');
  if (policies.length === 0) { el.innerHTML = '<p style="color:#64748b;font-size:13px">No policies yet.</p>'; return; }
  el.innerHTML = policies.map(p => `
    <div class="knowledge-item" data-id="${p.id}" style="background:#0f172a;border:1px solid #334155;border-radius:8px;padding:12px 16px;margin-bottom:8px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <strong style="color:#e2e8f0">${escHtml(p.title)}</strong>
        <button class="btn btn-danger btn-xs" onclick="deleteKnowledge(${p.id})">&#10005;</button>
      </div>
      <div style="color:#94a3b8;font-size:13px">${escHtml(p.content)}</div>
    </div>
  `).join('');
}

function renderScripts(scripts) {
  const el = document.getElementById('scriptsList');
  if (scripts.length === 0) { el.innerHTML = '<p style="color:#64748b;font-size:13px">No scripts yet.</p>'; return; }
  el.innerHTML = scripts.map(s => `
    <div class="script-item" data-id="${s.id}" style="background:#0f172a;border:1px solid #334155;border-radius:8px;padding:12px 16px;margin-bottom:8px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
        <span><span class="badge badge-blue">${escHtml(s.scenario)}</span> <strong style="color:#e2e8f0;margin-left:6px">${escHtml(s.label)}</strong></span>
        <button class="btn btn-danger btn-xs" onclick="deleteScript(${s.id})">&#10005;</button>
      </div>
      <div style="color:#94a3b8;font-size:13px">${escHtml(s.content)}</div>
    </div>
  `).join('');
}

document.getElementById('btnSaveApiKey').addEventListener('click', async () => {
  const val = document.getElementById('anthropicKey').value.trim();
  if (!val) return;
  await apiPut('/api/settings/anthropic_api_key', { value: val });
  document.getElementById('apiKeyStatus').textContent = ' Saved';
  setTimeout(() => document.getElementById('apiKeyStatus').textContent = '', 2000);
});

document.getElementById('btnSaveCampaignDetails').addEventListener('click', async () => {
  const fields = [
    { title: 'Campaign Name', el: 'kdCampaignName' },
    { title: 'Election Date', el: 'kdElectionDate' },
    { title: 'Website', el: 'kdWebsite' },
    { title: 'Key Message', el: 'kdSlogan' }
  ];
  for (const f of fields) {
    const val = document.getElementById(f.el).value.trim();
    if (!val) continue;
    // Check if exists
    const d = await api('/api/knowledge');
    const existing = (d.entries || []).find(e => e.type === 'details' && e.title === f.title);
    if (existing) {
      await apiPut('/api/knowledge/' + existing.id, { content: val });
    } else {
      await apiPost('/api/knowledge', { type: 'details', title: f.title, content: val });
    }
  }
  alert('Campaign details saved!');
});

document.getElementById('btnSaveBio').addEventListener('click', async () => {
  const val = document.getElementById('kdBio').value.trim();
  if (!val) return;
  const d = await api('/api/knowledge');
  const existing = (d.entries || []).find(e => e.type === 'bio');
  if (existing) {
    await apiPut('/api/knowledge/' + existing.id, { content: val });
  } else {
    await apiPost('/api/knowledge', { type: 'bio', title: 'Candidate Bio', content: val });
  }
  alert('Bio saved!');
});

document.getElementById('btnAddPolicy').addEventListener('click', async () => {
  const title = prompt('Policy title (e.g., "Healthcare")');
  if (!title) return;
  const content = prompt('Policy position details:');
  if (!content) return;
  await apiPost('/api/knowledge', { type: 'policy', title, content });
  loadKnowledge();
});

async function deleteKnowledge(id) {
  if (!confirm('Delete this entry?')) return;
  await apiDelete('/api/knowledge/' + id);
  loadKnowledge();
}

document.getElementById('btnAddScript').addEventListener('click', async () => {
  const scenario = prompt('Scenario (e.g., "supporter_positive", "hostile", "undecided_question")');
  if (!scenario) return;
  const label = prompt('Short label for this script:');
  if (!label) return;
  const content = prompt('Script text (the response message):');
  if (!content) return;
  await apiPost('/api/scripts', { scenario, label, content });
  loadKnowledge();
});

async function deleteScript(id) {
  if (!confirm('Delete this script?')) return;
  await apiDelete('/api/scripts/' + id);
  loadKnowledge();
}

// ===================== P2P TEXTING =====================
const p2pState = {
  volunteerId: null,
  sessionId: null,
  sessionName: '',
  isOnline: true,
  currentAssignment: null,
  pollTimer: null
};

function showP2pAdmin() {
  document.getElementById('p2p-admin-view').style.display = '';
  document.getElementById('p2p-session-view').style.display = 'none';
  document.getElementById('p2p-volunteer-view').style.display = 'none';
  if (p2pState.pollTimer) { clearInterval(p2pState.pollTimer); p2pState.pollTimer = null; }
  loadP2pSessions();
}

async function loadP2pContacts() {
  try {
    const d = await api('/api/contacts');
    const contacts = d.contacts || [];
    const el = document.getElementById('p2pContactList');
    el.innerHTML = contacts.map(c => `
      <label style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid #1e293b;font-size:14px;color:#e2e8f0;cursor:pointer">
        <input type="checkbox" class="p2p-contact-cb" value="${c.id}" style="accent-color:#818cf8">
        ${escHtml(c.first_name)} ${escHtml(c.last_name)} <span style="color:#64748b">${escHtml(c.phone)}</span>
      </label>
    `).join('');
    updateP2pSelectedCount();
    document.querySelectorAll('.p2p-contact-cb').forEach(cb => cb.addEventListener('change', updateP2pSelectedCount));
  } catch(e) {}
}

function updateP2pSelectedCount() {
  const checked = document.querySelectorAll('.p2p-contact-cb:checked').length;
  document.getElementById('p2pSelectedCount').textContent = checked + ' selected';
}

document.getElementById('btnP2pSelectAll').addEventListener('click', () => {
  document.querySelectorAll('.p2p-contact-cb').forEach(cb => cb.checked = true);
  updateP2pSelectedCount();
});
document.getElementById('btnP2pSelectNone').addEventListener('click', () => {
  document.querySelectorAll('.p2p-contact-cb').forEach(cb => cb.checked = false);
  updateP2pSelectedCount();
});

document.getElementById('btnCreateP2pSession').addEventListener('click', async () => {
  const name = document.getElementById('p2pSessionName').value.trim();
  const message_template = document.getElementById('p2pTemplate').value.trim();
  const assignment_mode = document.getElementById('p2pAssignMode').value;
  const contact_ids = [...document.querySelectorAll('.p2p-contact-cb:checked')].map(cb => Number(cb.value));
  if (!name || !message_template) return alert('Session name and message template required.');
  if (contact_ids.length === 0) return alert('Select at least one contact.');
  const d = await apiPost('/api/p2p/sessions', { name, message_template, assignment_mode, contact_ids });
  if (d.error) return alert(d.error);
  alert('Session created! Join code: ' + d.joinCode);
  document.getElementById('p2pSessionName').value = '';
  document.getElementById('p2pTemplate').value = '';
  loadP2pSessions();
});

async function loadP2pSessions() {
  try {
    const d = await api('/api/p2p/sessions');
    const sessions = d.sessions || [];
    const el = document.getElementById('p2pSessionsList');
    if (sessions.length === 0) { el.innerHTML = '<p style="color:#64748b;font-size:13px">No sessions yet.</p>'; return; }
    el.innerHTML = sessions.map(s => `
      <div style="background:#0f172a;border:1px solid #334155;border-radius:8px;padding:14px 18px;margin-bottom:10px;cursor:pointer" onclick="openP2pSession(${s.id})">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
          <strong style="color:#e2e8f0">${escHtml(s.name)}</strong>
          ${statusBadge(s.status)}
        </div>
        <div style="display:flex;gap:16px;font-size:13px;color:#94a3b8">
          <span>Code: <strong style="color:#818cf8">${s.join_code}</strong></span>
          <span>${s.sent}/${s.totalContacts} sent</span>
          <span>${s.onlineCount}/${s.volunteerCount} online</span>
        </div>
      </div>
    `).join('');
  } catch(e) {}
}

async function openP2pSession(id) {
  document.getElementById('p2p-admin-view').style.display = 'none';
  document.getElementById('p2p-session-view').style.display = '';
  try {
    const d = await api('/api/p2p/sessions/' + id);
    const s = d.session;
    document.getElementById('p2pSessionTitle').textContent = s.name;
    document.getElementById('p2pJoinCodeDisplay').textContent = s.join_code;
    document.getElementById('p2pCodeExpires').textContent = s.code_expires_at ? new Date(s.code_expires_at).toLocaleDateString() : '';
    document.getElementById('p2pStatSent').textContent = s.totalSent || 0;
    document.getElementById('p2pStatChats').textContent = s.totalReplies || 0;
    document.getElementById('p2pStatRemaining').textContent = s.remaining || 0;

    // Mode selector
    const modeSelect = document.getElementById('p2pModeSelect');
    modeSelect.innerHTML = '<option value="auto_split">Auto-Split</option><option value="claim">Claim</option><option value="manual">Manual</option>';
    modeSelect.value = s.assignment_mode;
    modeSelect.dataset.sessionId = s.id;

    // Volunteers
    const tbody = document.getElementById('p2pVolunteersBody');
    tbody.innerHTML = (s.volunteers || []).map(v => `
      <tr>
        <td>${escHtml(v.name)}</td>
        <td><span class="badge ${v.is_online ? 'badge-green' : 'badge-gray'}">${v.is_online ? 'Online' : 'Offline'}</span></td>
        <td>${v.sent || 0}</td>
        <td>${v.activeChats || 0}</td>
        <td>${v.remaining || 0}</td>
      </tr>
    `).join('');

    // Close session button
    document.getElementById('btnCloseSession').onclick = async () => {
      if (!confirm('Close this session?')) return;
      await apiPatch('/api/p2p/sessions/' + s.id, { status: 'closed' });
      showP2pAdmin();
    };
  } catch(e) { console.error(e); }
}

async function updateP2pMode() {
  const sel = document.getElementById('p2pModeSelect');
  await apiPatch('/api/p2p/sessions/' + sel.dataset.sessionId, { assignment_mode: sel.value });
}

// ===== VOLUNTEER JOIN =====
document.getElementById('btnJoinP2p').addEventListener('click', async () => {
  const name = document.getElementById('p2pJoinName').value.trim();
  const code = document.getElementById('p2pJoinCode').value.trim();
  if (!name || !code) return alert('Name and join code required.');
  const d = await apiPost('/api/p2p/join', { name, code });
  if (d.error) return alert(d.error);
  p2pState.volunteerId = d.volunteerId;
  p2pState.sessionId = d.sessionId;
  p2pState.sessionName = d.sessionName;
  p2pState.isOnline = true;
  showP2pVolunteer();
});

function showP2pVolunteer() {
  document.getElementById('p2p-admin-view').style.display = 'none';
  document.getElementById('p2p-session-view').style.display = 'none';
  document.getElementById('p2p-volunteer-view').style.display = '';
  document.getElementById('p2pJoinCard').style.display = 'none';
  document.getElementById('p2pVolName').textContent = document.getElementById('p2pJoinName').value;
  document.getElementById('p2pVolSession').textContent = p2pState.sessionName;
  document.getElementById('p2pReplyCard').style.display = 'none';
  loadVolunteerQueue();
  // Start polling
  if (p2pState.pollTimer) clearInterval(p2pState.pollTimer);
  p2pState.pollTimer = setInterval(loadVolunteerQueue, 5000);
}

function leaveP2pVolunteer() {
  if (p2pState.pollTimer) { clearInterval(p2pState.pollTimer); p2pState.pollTimer = null; }
  p2pState.volunteerId = null;
  p2pState.sessionId = null;
  document.getElementById('p2p-volunteer-view').style.display = 'none';
  document.getElementById('p2pJoinCard').style.display = '';
  showP2pAdmin();
}

async function loadVolunteerQueue() {
  if (!p2pState.volunteerId) return;
  try {
    const d = await api('/api/p2p/volunteers/' + p2pState.volunteerId + '/queue');
    // Progress
    document.getElementById('p2pVolProgress').textContent = (d.stats.sent || 0) + ' sent / ' + (d.stats.remaining || 0) + ' remaining';

    // Next contact in queue
    const qCard = document.getElementById('p2pQueueCard');
    if (d.assignment) {
      qCard.style.display = '';
      p2pState.currentAssignment = d.assignment;
      document.getElementById('p2pContactInfo').innerHTML = `
        <div style="font-size:16px;color:#e2e8f0;margin-bottom:4px"><strong>${escHtml(d.assignment.first_name)} ${escHtml(d.assignment.last_name)}</strong></div>
        <div style="font-size:13px;color:#94a3b8">${escHtml(d.assignment.phone)}${d.assignment.city ? '  ' + escHtml(d.assignment.city) : ''}</div>
      `;
      document.getElementById('p2pMessage').value = d.resolvedMessage || '';
    } else {
      qCard.style.display = 'none';
      p2pState.currentAssignment = null;
      if ((d.stats.remaining || 0) === 0) {
        document.getElementById('p2pContactInfo').innerHTML = '<p style="color:#64748b">All contacts in your queue have been texted! </p>';
      }
    }

    // Active conversations
    const convCard = document.getElementById('p2pConversationsCard');
    const convList = document.getElementById('p2pConversationsList');
    if (d.activeConversations && d.activeConversations.length > 0) {
      convCard.style.display = '';
      document.getElementById('p2pConvCount').textContent = d.activeConversations.length;
      convList.innerHTML = d.activeConversations.map(c => `
        <div style="background:#0f172a;border:1px solid #334155;border-radius:8px;padding:10px 14px;margin-bottom:8px;cursor:pointer;display:flex;justify-content:space-between;align-items:center" onclick="openP2pConversation(${c.id})">
          <div>
            <strong style="color:#e2e8f0">${escHtml(c.first_name)} ${escHtml(c.last_name)}</strong>
            <span style="color:#64748b;font-size:13px;margin-left:8px">${escHtml(c.phone)}</span>
          </div>
          <span class="badge badge-blue">Reply</span>
        </div>
      `).join('');
    } else {
      convCard.style.display = 'none';
    }
  } catch(e) { console.error(e); }
}

// ===== SEND / SKIP =====
document.getElementById('btnP2pSend').addEventListener('click', async () => {
  if (!p2pState.currentAssignment) return;
  const message = document.getElementById('p2pMessage').value.trim();
  if (!message) return alert('Message cannot be empty.');
  const creds = state.credentials;
  if (!creds.accountSid || !creds.authToken || !creds.fromNumber) return alert('Set up Twilio credentials first (Setup page).');
  const d = await apiPost('/api/p2p/send', {
    volunteerId: p2pState.volunteerId,
    assignmentId: p2pState.currentAssignment.id,
    message,
    accountSid: creds.accountSid,
    authToken: creds.authToken,
    from: creds.fromNumber
  });
  if (d.error) return alert(d.error);
  loadVolunteerQueue();
});

document.getElementById('btnP2pSkip').addEventListener('click', async () => {
  if (!p2pState.currentAssignment) return;
  await apiPatch('/api/p2p/assignments/' + p2pState.currentAssignment.id + '/skip');
  loadVolunteerQueue();
});

// ===== ONLINE / OFFLINE TOGGLE =====
document.getElementById('btnToggleOnline').addEventListener('click', async () => {
  p2pState.isOnline = !p2pState.isOnline;
  await apiPatch('/api/p2p/volunteers/' + p2pState.volunteerId + '/status', { is_online: p2pState.isOnline });
  const btn = document.getElementById('btnToggleOnline');
  btn.textContent = p2pState.isOnline ? 'Go Offline' : 'Go Online';
  btn.className = p2pState.isOnline ? 'btn btn-secondary btn-sm' : 'btn btn-success btn-sm';
  if (p2pState.isOnline) loadVolunteerQueue();
});

// ===== CONVERSATION THREAD =====
async function openP2pConversation(assignmentId) {
  document.getElementById('p2pQueueCard').style.display = 'none';
  document.getElementById('p2pConversationsCard').style.display = 'none';
  document.getElementById('p2pReplyCard').style.display = '';
  try {
    const d = await api('/api/p2p/conversations/' + assignmentId);
    document.getElementById('p2pReplyHeader').textContent = (d.assignment.first_name || '') + ' ' + (d.assignment.last_name || '');
    const thread = document.getElementById('p2pThread');
    thread.innerHTML = (d.messages || []).map(m => `
      <div style="padding:8px 12px;border-radius:8px;margin-bottom:6px;max-width:80%;${m.direction === 'outbound' ? 'background:#312e81;margin-left:auto;text-align:right' : 'background:#1e293b'}">
        <div style="font-size:13px;color:#e2e8f0">${escHtml(m.body)}</div>
        <div style="font-size:11px;color:#64748b;margin-top:4px">${m.direction === 'outbound' ? ' Sent' : ' Received'}${m.volunteer_name ? ' by ' + escHtml(m.volunteer_name) : ''}</div>
      </div>
    `).join('');
    thread.scrollTop = thread.scrollHeight;

    // Get AI suggestion for last inbound message
    const lastInbound = (d.messages || []).filter(m => m.direction === 'inbound').pop();
    if (lastInbound) {
      getSuggestion(lastInbound.body, d.assignment.first_name, lastInbound.sentiment, assignmentId);
    }

    // Wire reply buttons
    document.getElementById('btnSendReply').onclick = async () => {
      const body = document.getElementById('p2pReplyText').value.trim();
      if (!body) return alert('Type a reply.');
      const creds = state.credentials;
      if (!creds.accountSid || !creds.authToken || !creds.fromNumber) return alert('Set up Twilio credentials first.');
      await apiPost('/api/p2p/send', {
        volunteerId: p2pState.volunteerId,
        assignmentId,
        message: body,
        accountSid: creds.accountSid,
        authToken: creds.authToken,
        from: creds.fromNumber
      });
      openP2pConversation(assignmentId);
    };

    document.getElementById('btnMarkComplete').onclick = async () => {
      await apiPatch('/api/p2p/assignments/' + assignmentId + '/complete');
      closeP2pReply();
      loadVolunteerQueue();
    };
  } catch(e) { console.error(e); }
}

function closeP2pReply() {
  document.getElementById('p2pReplyCard').style.display = 'none';
  document.getElementById('p2pQueueCard').style.display = '';
  document.getElementById('p2pConversationsCard').style.display = '';
  document.getElementById('p2pSuggestion').style.display = 'none';
  document.getElementById('p2pReplyText').value = '';
}

// ===== AI SUGGESTIONS =====
async function getSuggestion(voterMessage, voterName, sentiment, assignmentId) {
  const sugEl = document.getElementById('p2pSuggestion');
  sugEl.style.display = 'none';
  try {
    const d = await apiPost('/api/p2p/suggest-reply', {
      voterMessage,
      voterName: voterName || 'Voter',
      sentiment: sentiment || 'neutral',
      sessionName: p2pState.sessionName
    });
    if (d.suggestion) {
      sugEl.style.display = '';
      document.getElementById('p2pSuggestionText').textContent = d.suggestion;
      document.getElementById('p2pSuggestionSource').textContent = d.source === 'ai' ? 'AI' : d.source === 'script' ? 'Script' : '';

      document.getElementById('btnApproveSuggestion').onclick = async () => {
        const creds = state.credentials;
        if (!creds.accountSid || !creds.authToken || !creds.fromNumber) return alert('Set up Twilio credentials first.');
        await apiPost('/api/p2p/send', {
          volunteerId: p2pState.volunteerId,
          assignmentId,
          message: d.suggestion,
          accountSid: creds.accountSid,
          authToken: creds.authToken,
          from: creds.fromNumber
        });
        openP2pConversation(assignmentId);
      };

      document.getElementById('btnEditSuggestion').onclick = () => {
        document.getElementById('p2pReplyText').value = d.suggestion;
        sugEl.style.display = 'none';
      };

      document.getElementById('btnWriteOwn').onclick = () => {
        document.getElementById('p2pReplyText').value = '';
        document.getElementById('p2pReplyText').focus();
        sugEl.style.display = 'none';
      };
    }
  } catch(e) { console.error(e); }
}

// ===================== INIT =====================
(async function init() {
  loadCredentials();
  await migrateLocalStorage();
  await loadContacts();
  await loadDashboard();
})();
</script>
</body>
</html>
